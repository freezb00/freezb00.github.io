<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€¼è¿­ä»£å…¬å¼ä¸æ¨¡å‹äº”è¦ç´ è¯¦è§£</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Balsamiq+Sans:wght@400;700&family=ZCOOL+KuaiLe&display=swap');

        :root {
            --bg-paper: #FAFAFA;
            --grid-line: #EEEEEE;
            --panel: #ffffff;
            --primary: #424242;
            --accent: #757575;
            --ink-color: #212121;
            --border-color: #424242;
            --text-main: #212121;
            --text-sub: #616161;
            --shadow: rgba(0, 0, 0, 0.12);
            
            /* å…¬å¼å…³é”®ç‚¹é…è‰² - ä¿ç•™é²œæ˜è‰²å½©åŒºåˆ† */
            --c-r: #E91E63;      /* R å¥–åŠ± - ç²‰çº¢ */
            --c-g: #4CAF50;      /* Î³ æŠ˜æ‰£ - ç»¿è‰² */
            --c-v: #2196F3;      /* V ä»·å€¼ - è“è‰² */
            --c-p: #FF9800;      /* P æ¦‚ç‡ - æ©™è‰² */
        }

        body {
            font-family: 'Balsamiq Sans', 'ZCOOL KuaiLe', cursive;
            background-color: var(--bg-paper);
            background-image: 
                linear-gradient(var(--grid-line) 2px, transparent 2px),
                linear-gradient(90deg, var(--grid-line) 2px, transparent 2px);
            background-size: 25px 25px;
            color: var(--ink-color);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            user-select: none;
        }

        /* é¡¶éƒ¨ï¼šæ ‡é¢˜ + å…¬å¼ */
        header {
            background: var(--panel);
            border-bottom: 3px solid var(--border-color);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
            box-shadow: 0 4px 0px var(--shadow);
        }

        .header-left h1 { 
            margin: 0; 
            font-size: 1.2rem; 
            color: var(--primary); 
            text-shadow: 2px 2px 0px var(--grid-line);
        }
        .header-left p { 
            margin: 0; 
            font-size: 0.85rem; 
            color: var(--text-sub); 
        }

        /* æ ¸å¿ƒå…¬å¼å±•ç¤ºåŒº */
        .formula-box {
            background: #FAFAFA;
            padding: 10px 20px;
            border-radius: 12px 20px 15px 25px;
            border: 3px solid #424242;
            font-family: 'Cambria Math', 'Times New Roman', serif;
            font-size: 1.15rem;
            color: #212121;
            box-shadow: 4px 4px 0px rgba(0, 0, 0, 0.15);
        }
        .math-term { display: inline-block; padding: 0 2px; }
        .m-max { font-weight: bold; color: #212121; }
        .m-r { color: #E91E63; font-weight: bold; }    /* å¥–åŠ± R - ç²‰çº¢ */
        .m-g { color: #4CAF50; font-weight: bold; }    /* æŠ˜æ‰£ Î³ - ç»¿è‰² */
        .m-p { color: #FF9800; font-weight: bold; }    /* æ¦‚ç‡ P - æ©™è‰² */
        .m-v { color: #2196F3; font-weight: bold; }    /* ä»·å€¼ V - è“è‰² */

        /* ä¸»å®¹å™¨ */
        .container {
            display: flex;
            flex: 1;
            padding: 20px;
            gap: 20px;
            overflow: hidden;
        }

        /* é¢æ¿é€šç”¨æ ·å¼ */
        .panel {
            background: var(--panel);
            border-radius: 15px 25px 15px 25px;
            border: 3px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 5px 5px 0px var(--shadow);
        }
        .panel-head {
            background: #F5F5F5;
            padding: 12px 15px;
            border-bottom: 3px solid #424242;
            font-size: 0.95rem;
            font-weight: 700;
            color: #424242;
            letter-spacing: 0.5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* å·¦ä¾§ï¼šå¯è§†åŒ– S å’Œ R */
        .grid-panel { flex: 2; }
        .grid-content {
            flex: 1; display: flex; align-items: center; justify-content: center; position: relative;
        }
        .grid-wrapper {
            display: grid; grid-template-columns: repeat(3, 110px); gap: 15px;
        }
        .cell {
            width: 110px; height: 110px;
            border: 3px solid #CFD8DC; 
            border-radius: 12px 20px 15px 25px;
            position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: all 0.3s;
            background: #FAFAFA;
            box-shadow: 3px 3px 0px rgba(0,0,0,0.05);
        }
        .cell-id { position: absolute; top: 5px; left: 8px; color: #BDBDBD; font-size: 0.85rem; font-weight: bold; }
        .cell-r { position: absolute; top: 5px; right: 8px; font-weight: bold; font-size: 0.9rem; }
        .cell-v { font-size: 1.8rem; font-weight: bold; color: var(--c-v); z-index: 2; }
        
        .cell.active { 
            border-color: #212121; 
            background-color: #F5F5F5; 
            transform: scale(1.05);
            box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.2);
        }
        .cell.target { 
            border-color: #616161; 
            background: linear-gradient(135deg, #E0E0E0, #BDBDBD); 
        }

        /* ç®­å¤´ */
        .arrows { position: absolute; inset: 0; pointer-events: none; }
        .arr { position: absolute; color: #E0E0E0; transition: all 0.2s; font-size: 18px; }
        .arr.active { color: #212121; transform: scale(1.3); font-weight: bold; }
        .arr-up { top: 5px; left: 45%; } .arr-down { bottom: 5px; left: 45%; }
        .arr-left { top: 45%; left: 5px; } .arr-right { top: 45%; right: 5px; }

        /* ä¸­é—´ï¼šæ—¥å¿— */
        .log-panel { flex: 3; }
        .log-content { 
            flex: 1; 
            overflow-y: auto; 
            padding: 15px; 
            font-family: 'Consolas', 'Balsamiq Sans', monospace; 
            font-size: 0.9rem; 
        }
        .log-item { 
            margin-bottom: 10px; 
            padding: 8px 12px; 
            border-left: 4px solid transparent; 
            border-radius: 0 8px 8px 0;
            background: #FAFAFA;
        }
        .l-phase { 
            border-color: #424242; 
            background: #F5F5F5; 
            font-weight: bold; 
            margin-top: 15px; 
        }
        .l-calc { 
            border-color: #BDBDBD; 
            color: #555; 
        }
        .l-res { 
            border-color: #212121; 
            background: #EEEEEE; 
            color: #212121; 
            font-weight: bold;
        }

        /* å³ä¾§ï¼šæ¨¡å‹ä¸ä¸Šå¸è§†è§’ */
        .model-panel { 
            flex: 2; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            background: transparent; 
            border: none; 
            box-shadow: none;
        }
        
        /* 1. MDP äº”è¦ç´ å®šä¹‰å¡ç‰‡ */
        .mdp-card {
            background: #fff; 
            border-radius: 15px 25px 15px 25px; 
            padding: 15px; 
            border: 3px solid var(--border-color);
            box-shadow: 5px 5px 0px var(--shadow);
        }
        .tuple-list { list-style: none; padding: 0; margin: 0; font-size: 0.85rem; color: #555; }
        .tuple-item { margin-bottom: 8px; display: flex; align-items: flex-start; }
        .tuple-key { font-weight: bold; width: 30px; display: inline-block; color: var(--primary); }
        .tuple-val { flex: 1; }

        /* 2. Oracle åŠ¨æ€å¡ç‰‡ */ 
        .oracle-card {
            background: #FAFAFA;
            border-left: 6px solid #424242;
            border-radius: 15px 25px 15px 25px;
            padding: 15px;
            border: 3px solid #616161;
            box-shadow: 5px 5px 0px rgba(0, 0, 0, 0.12);
            transition: all 0.2s;
        }
        .oracle-card.querying {
            background: #EEEEEE;
            transform: scale(1.02);
        }
        .oracle-title { color: #424242; font-weight: bold; font-size: 0.9rem; margin-bottom: 10px; text-transform: uppercase; }
        .oracle-data { font-family: 'Consolas', monospace; font-size: 1rem; color: #212121; line-height: 1.8; }
        .oracle-note { font-size: 0.85rem; color: #616161; margin-top: 10px; line-height: 1.5; }

        .hl-math { background: rgba(0,0,0,0.05); padding: 2px 4px; border-radius: 3px; }

        /* åº•éƒ¨æ§åˆ¶æ  */
        .controls-bar {
            background: #fff;
            border-top: 3px solid var(--border-color);
            padding: 12px 25px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            box-shadow: 0 -4px 0px var(--shadow);
        }

        /* æŒ‰é’® */
        .controls-bar button {
            padding: 10px 22px; 
            border-radius: 12px; 
            border: 3px solid var(--border-color); 
            cursor: pointer; 
            font-weight: 700; 
            font-size: 0.95rem; 
            font-family: inherit;
            box-shadow: 3px 3px 0px var(--border-color);
            transition: all 0.2s;
        }
        .controls-bar button:hover { 
            transform: translateY(-2px); 
        }
        .controls-bar button:active { 
            transform: translate(3px, 3px); 
            box-shadow: none; 
        }
        .controls-bar button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .btn-reset { 
            background: #EEEEEE; 
            color: #424242; 
            border-color: #9E9E9E;
            box-shadow: 3px 3px 0px #9E9E9E;
        }
        .btn-reset:hover { background: #E0E0E0; }
        .btn-prev {
            background: #ECEFF1;
            color: var(--ink-color);
        }
        .btn-prev:hover { background: #CFD8DC; }
        .btn-next { 
            background: #424242; 
            color: white; 
            border-color: #212121;
            box-shadow: 3px 3px 0px #212121;
        }
        .btn-next:hover { 
            background: #616161;
        }
        .btn-auto {
            background: #EEEEEE;
            color: #424242;
            border-color: #9E9E9E;
            box-shadow: 3px 3px 0px #9E9E9E;
        }
        .btn-auto:hover { background: #E0E0E0; }
        .btn-auto.playing {
            background: #E0E0E0;
            color: #212121;
            border-color: #616161;
            box-shadow: 3px 3px 0px #616161;
        }
        .btn-auto.playing:hover { background: #BDBDBD; }
        .speed-control {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
            color: var(--ink-color);
        }
        .speed-control input {
            width: 80px;
        }

        /* æ”¶æ•›ä¿¡æ¯æ˜¾ç¤º */
        .convergence-info {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.85rem;
            padding: 8px 15px;
            background: #F5F5F5;
            border-radius: 10px;
            border: 2px solid #9E9E9E;
        }
        .conv-label { color: #424242; font-weight: bold; }
        .conv-formula { font-family: 'Cambria Math', serif; color: #212121; }
        .conv-value { color: #212121; background: #E0E0E0; padding: 2px 8px; border-radius: 5px; }
        .conv-delta { color: #212121; font-family: 'Consolas', monospace; }
        .conv-status { font-weight: bold; padding: 2px 10px; border-radius: 5px; }
        .conv-status.converged { background: #C8E6C9; color: #2E7D32; }
        .conv-status.running { background: #EEEEEE; color: #616161; }

    </style>
</head>
<body>

<header>
    <div class="header-left">
        <h1>ğŸ“Š Value Iteration (Model-Based)</h1>
        <p>åŸºäºè´å°”æ›¼æœ€ä¼˜æ–¹ç¨‹çš„è§„åˆ’</p>
    </div>
    
    <!-- æ”¶æ•›æ¡ä»¶æ˜¾ç¤º -->
    <div class="convergence-info" id="convergenceInfo">
        <span class="conv-label">æ”¶æ•›æ¡ä»¶:</span>
        <span class="conv-formula">max|Î”V| < Îµ</span>
        <span class="conv-value">Îµ = 0.01</span>
        <span class="conv-delta" id="convDelta">å½“å‰ max|Î”V| = --</span>
        <span class="conv-status" id="convStatus">â³ ç­‰å¾…å¼€å§‹</span>
    </div>
    
    <!-- æ ¸å¿ƒå…¬å¼å±•ç¤º -->
    <div class="formula-box">
        V<sub>k+1</sub>(s) = <span class="m-max">max</span><sub>a</sub> 
        [ 
        <span class="m-r">R</span> + 
        <span class="m-g">Î³</span> Â· 
        <span class="m-p">Î£P</span> Â· 
        <span class="m-v">V<sub>k</sub>(s')</span> 
        ]
    </div>
</header>

<div class="container">
    
    <!-- 1. å¯è§†åŒ–å±‚ï¼šåªæœ‰ S å’Œ R -->
    <div class="panel grid-panel">
        <div class="panel-head">
            <span>ğŸŒ Visual World (S & R)</span>
            <span style="font-size:0.75rem; font-weight:normal; color:#999;">æ™ºèƒ½ä½“çœ¼ä¸­çš„ç½‘æ ¼</span>
        </div>
        <div class="grid-content">
            <div class="grid-wrapper" id="grid">
                <!-- JS ç”Ÿæˆæ ¼å­ -->
            </div>
        </div>
    </div>

    <!-- 2. è¿‡ç¨‹å±‚ï¼šæ—¥å¿— -->
    <div class="panel log-panel">
        <div class="panel-head">ğŸ“ Calculation History</div>
        <div class="log-content" id="logContent">
            <div style="text-align:center; color:#aaa; margin-top:20px;">ç‚¹å‡»"ä¸‹ä¸€æ­¥"å¼€å§‹æ¨æ¼”</div>
        </div>
    </div>

    <!-- 3. æ¨¡å‹å±‚ï¼šäº”è¦ç´ ä¸ P -->
    <div class="model-panel">
        
        <!-- é™æ€ï¼šMDP å®šä¹‰ -->
        <div class="mdp-card">
            <div style="font-weight:bold; margin-bottom:10px; border-bottom:2px dashed #BDBDBD; padding-bottom:8px; color: #424242;">
                ğŸ“‹ MDP äº”è¦ç´  (The Known Model)
            </div>
            <ul class="tuple-list">
                <li class="tuple-item">
                    <span class="tuple-key">S</span>
                    <span class="tuple-val">çŠ¶æ€ç©ºé—´ (å·¦ä¾§çš„ 6 ä¸ªæ ¼å­)</span>
                </li>
                <li class="tuple-item">
                    <span class="tuple-key">A</span>
                    <span class="tuple-val">åŠ¨ä½œç©ºé—´ {ä¸Š, ä¸‹, å·¦, å³}</span>
                </li>
                <li class="tuple-item">
                    <span class="tuple-key" style="color:var(--c-p)">P</span>
                    <span class="tuple-val"><b>çŠ¶æ€è½¬ç§»æ¦‚ç‡ (éšå½¢è§„åˆ™)</b><br>ä¾‹å¦‚: æ’å¢™å›åŸä½, æ¦‚ç‡=1.0</span>
                </li>
                <li class="tuple-item">
                    <span class="tuple-key" style="color:var(--c-r)">R</span>
                    <span class="tuple-val">å¥–åŠ±å‡½æ•° (S2=+10, S5=-10)</span>
                </li>
                <li class="tuple-item">
                    <span class="tuple-key" style="color:var(--c-g)">Î³</span>
                    <span class="tuple-val">æŠ˜æ‰£å› å­ = 0.9</span>
                </li>
            </ul>
        </div>

        <!-- åŠ¨æ€ï¼šæ¨¡å‹æŸ¥è¯¢ (Oracle) -->
        <div class="oracle-card" id="oracleCard">
            <div class="oracle-title">
                ğŸ”® Model Query (ä¸Šå¸è§†è§’)
            </div>
            <div id="oracleContent" class="oracle-data">
                <span style="color:#aaa">// ç­‰å¾…ç®—æ³•æŸ¥è¯¢ P å’Œ R...</span>
            </div>
            <div class="oracle-note" id="oracleDesc">
                å½“ç®—æ³•å°è¯•åŠ¨ä½œæ—¶ï¼Œä¼šåœ¨è¿™é‡Œä» P çŸ©é˜µä¸­è¯»å–ç»“æœã€‚
            </div>
        </div>

    </div>
</div>

<!-- åº•éƒ¨æ§åˆ¶æ  -->
<div class="controls-bar">
    <button class="btn-reset" onclick="reset()">ğŸ”„ é‡ç½®</button>
    <button class="btn-prev" onclick="prev()" id="btnPrev" disabled>â® ä¸Šä¸€æ­¥</button>
    <button class="btn-auto" onclick="toggleAutoPlay()" id="btnAuto">â–¶ï¸ è‡ªåŠ¨æ’­æ”¾</button>
    <div class="speed-control">
        <span>é€Ÿåº¦:</span>
        <input type="range" id="speedSlider" min="100" max="2000" value="800" onchange="updateSpeed()">
        <span id="speedLabel">0.8s</span>
    </div>
    <button class="btn-next" onclick="next()" id="btnNext">ä¸‹ä¸€æ­¥ â­</button>
</div>

<script>
    // --- é…ç½® ---
    const GAMMA = 0.9;
    const ROWS = 2, COLS = 3;
    const ACTIONS = ['UP', 'DOWN', 'LEFT', 'RIGHT'];
    const ACTION_SYMBOLS = { UP: 'â†‘', DOWN: 'â†“', LEFT: 'â†', RIGHT: 'â†’' };

    // çŠ¶æ€å®šä¹‰ (S, R)
    const MODEL = [
        { id: 0, r: 0,   type: 'normal' },
        { id: 1, r: 0,   type: 'normal' },
        { id: 2, r: 10,  type: 'terminal' },
        { id: 3, r: 0,   type: 'normal' },
        { id: 4, r: 0,   type: 'normal' },
        { id: 5, r: -10, type: 'terminal' }
    ];

    // === å†å²è®°å½•ç³»ç»Ÿ ===
    let history = [];
    let historyIndex = -1;

    // è¿è¡Œæ—¶å˜é‡
    let V = Array(6).fill(0);
    let V_next = Array(6).fill(0);
    let stateIdx = 0;
    let actionIdx = 0;
    let tempQValues = [];
    let phase = 'INIT'; // INIT -> STATE -> ACTION -> UPDATE -> DONE
    let iteration = 1;
    let logs = [];
    let maxDelta = 0;  // æ”¶æ•›æ£€æµ‹
    const EPSILON = 0.01;  // æ”¶æ•›é˜ˆå€¼
    let isConverged = false;
    let autoPlayTimer = null;  // è‡ªåŠ¨æ’­æ”¾å®šæ—¶å™¨
    let autoPlaySpeed = 800;   // æ’­æ”¾é€Ÿåº¦(ms)

    // DOM Elements
    const gridEl = document.getElementById('grid');
    const logEl = document.getElementById('logContent');
    const oracleContent = document.getElementById('oracleContent');
    const oracleDesc = document.getElementById('oracleDesc');
    const oracleCard = document.getElementById('oracleCard');
    const btnNext = document.getElementById('btnNext');
    const btnPrev = document.getElementById('btnPrev');

    // --- çŠ¶æ€ä¿å­˜ä¸æ¢å¤ ---
    function saveState() {
        return {
            V: [...V],
            V_next: [...V_next],
            stateIdx,
            actionIdx,
            tempQValues: [...tempQValues],
            phase,
            iteration,
            logs: [...logs],
            maxDelta,
            isConverged
        };
    }

    function restoreState(state) {
        V = [...state.V];
        V_next = [...state.V_next];
        stateIdx = state.stateIdx;
        actionIdx = state.actionIdx;
        tempQValues = [...state.tempQValues];
        phase = state.phase;
        iteration = state.iteration;
        logs = [...state.logs];
        maxDelta = state.maxDelta || 0;
        isConverged = state.isConverged || false;
    }

    function pushHistory() {
        history = history.slice(0, historyIndex + 1);
        history.push(saveState());
        historyIndex = history.length - 1;
        updateButtons();
    }

    function updateButtons() {
        btnPrev.disabled = historyIndex <= 0;
    }

    // --- åˆå§‹åŒ– ---
    function init() {
        // ç»ˆæ­¢çŠ¶æ€çš„Vå€¼åˆå§‹åŒ–ä¸ºå…¶å¥–åŠ±å€¼
        MODEL.forEach((m, i) => {
            if(m.type === 'terminal') {
                V[i] = m.r;
                V_next[i] = m.r;
            }
        });
        renderGrid();
        updateConvergenceDisplay();
        logs = ['<div style="padding:10px; color:#666;">ç³»ç»Ÿåˆå§‹åŒ–: ç»ˆæ­¢çŠ¶æ€ V(S2)=10, V(S5)=-10ï¼Œå…¶ä»– V(s)=0<br>ç‚¹å‡»"ä¸‹ä¸€æ­¥"å¼€å§‹å€¼è¿­ä»£ã€‚</div>'];
        renderLogs();
        resetOracle();
        pushHistory();
    }

    function renderLogs() {
        logEl.innerHTML = logs.join('');
        setTimeout(() => logEl.scrollTop = logEl.scrollHeight, 10);
    }

    function renderGrid() {
        gridEl.innerHTML = '';
        MODEL.forEach((m, i) => {
            let div = document.createElement('div');
            div.className = `cell ${m.type === 'terminal' ? 'target' : ''}`;
            div.id = `cell-${i}`;
            
            // å¥–åŠ±å±•ç¤º
            let rText = '';
            if(m.r !== 0) {
                let color = m.r > 0 ? '#4CAF50' : '#F44336';  // æ­£å¥–åŠ±ç»¿è‰²ï¼Œè´Ÿå¥–åŠ±çº¢è‰²
                rText = `<div class="cell-r" style="color:${color}">R=${m.r}</div>`;
            }

            div.innerHTML = `
                <div class="cell-id">S${i}</div>
                ${rText}
                <div class="cell-v">${V[i].toFixed(2)}</div>
                <div class="arrows">
                    <div class="arr arr-up">â–²</div>
                    <div class="arr arr-down">â–¼</div>
                    <div class="arr arr-left">â—€</div>
                    <div class="arr arr-right">â–¶</div>
                </div>
            `;
            gridEl.appendChild(div);
        });
    }

    // --- æ¨¡å‹é€»è¾‘ P(s'|s,a) ---
    function getNextState(s, a) {
        let r = Math.floor(s / COLS);
        let c = s % COLS;
        if(a === 'UP') r--;
        if(a === 'DOWN') r++;
        if(a === 'LEFT') c--;
        if(a === 'RIGHT') c++;
        if(r < 0 || r >= ROWS || c < 0 || c >= COLS) return s; // æ’å¢™
        return r * COLS + c;
    }

    // --- æ­¥è¿›é€»è¾‘ ---
    function next() {
        pushHistory();

        switch(phase) {
            case 'INIT':
                addLog(`ğŸš€ ç¬¬ ${iteration} è½®è¿­ä»£å¼€å§‹`, 'l-phase');
                addLog(`<small style="color:#78909C">ä¾æ¬¡éå†æ‰€æœ‰éç»ˆæ­¢çŠ¶æ€ï¼Œè®¡ç®—æ–°çš„ä»·å€¼ä¼°è®¡</small>`, 'l-calc');
                stateIdx = 0;
                V_next = [...V]; // å…³é”®ï¼šæ¯è½®å¼€å§‹æ—¶å¤åˆ¶å½“å‰Vå€¼
                phase = 'STATE';
                next();
                break;

            case 'STATE':
                clearVisuals();
                highlightCell(stateIdx);
                
                // ç»ˆæ­¢çŠ¶æ€å¤„ç†
                if(MODEL[stateIdx].type === 'terminal') {
                    addLog(`â­ S${stateIdx} æ˜¯ç»ˆæ­¢çŠ¶æ€ (R=${MODEL[stateIdx].r})ï¼Œè·³è¿‡æ›´æ–°`, 'l-calc');
                    showTerminalOracle(stateIdx);
                    stateIdx++;
                    if(stateIdx >= 6) phase = 'DONE';
                    return; // æš‚åœè®©ç”¨æˆ·çœ‹
                }

                addLog(`ğŸ“ å¼€å§‹è®¡ç®— <b>S${stateIdx}</b> çš„ä»·å€¼`, 'l-calc');
                addLog(`<small style="color:#78909C">éœ€è¦å°è¯•4ä¸ªåŠ¨ä½œï¼Œæ‰¾å‡ºæœ€å¤§Qå€¼</small>`, 'l-calc');
                actionIdx = 0;
                tempQValues = [];
                phase = 'ACTION';
                next(); // è‡ªåŠ¨è¿›åŠ¨ä½œ
                break;

            case 'ACTION':
                let action = ACTIONS[actionIdx];
                let nextS = getNextState(stateIdx, action);
                // å¥–åŠ±æ˜¯è¿›å…¥ä¸‹ä¸€çŠ¶æ€è·å¾—çš„ï¼ˆåªæœ‰è¿›å…¥ç»ˆæ­¢çŠ¶æ€æ‰æœ‰éé›¶å¥–åŠ±ï¼‰
                let reward = MODEL[nextS].r; 
                let vOld = V[nextS];
                // å¦‚æœè¿›å…¥ç»ˆæ­¢çŠ¶æ€ï¼Œåç»­ä»·å€¼ä¸º0ï¼ˆå› ä¸ºæ¸¸æˆç»“æŸï¼‰
                let futureV = MODEL[nextS].type === 'terminal' ? 0 : vOld;
                
                // UI
                highlightArrow(stateIdx, action);
                updateOracle(stateIdx, action, nextS, reward);

                // æ ¸å¿ƒè®¡ç®—: Q(s,a) = R(s,a) + Î³ * V(s')
                // è¿›å…¥ç»ˆæ­¢çŠ¶æ€æ—¶ï¼ŒfutureV=0ï¼ˆæ¸¸æˆç»“æŸï¼Œæ— åç»­ä»·å€¼ï¼‰
                let q = reward + GAMMA * futureV;
                tempQValues.push(q);

                let futureNote = MODEL[nextS].type === 'terminal' ? ' (ç»ˆæ­¢)' : '';
                addLog(`
                    &nbsp;&nbsp;${ACTION_SYMBOLS[action]} ${action} â†’ S${nextS}${futureNote}: 
                    <span style="color:var(--c-r)">${reward}</span> + 
                    <span style="color:var(--c-g)">${GAMMA}</span> Ã— 
                    <span style="color:var(--c-v)">${futureV.toFixed(2)}</span> = 
                    <b>${q.toFixed(2)}</b>
                `, 'l-calc');

                actionIdx++;
                if(actionIdx >= ACTIONS.length) {
                    phase = 'UPDATE';
                    btnNext.textContent = "æ›´æ–° V(s) âœ“";
                }
                break;

            case 'UPDATE':
                let maxQ = Math.max(...tempQValues);
                let bestIdx = tempQValues.indexOf(maxQ);
                V_next[stateIdx] = maxQ;

                // UI: æ˜¾ç¤ºå¾…æ›´æ–°å€¼ï¼ˆç”¨ä¸åŒé¢œè‰²æ ‡è®°ï¼Œä½†ä¸æ”¹å˜Væ•°ç»„ï¼‰
                let cellV = document.querySelector(`#cell-${stateIdx} .cell-v`);
                cellV.textContent = `${V[stateIdx].toFixed(2)}â†’${maxQ.toFixed(2)}`;
                cellV.style.color = 'var(--primary)';
                cellV.style.fontSize = '1.2rem';

                addLog(`âœ… V(S${stateIdx}) â† max(Q) = <b>${maxQ.toFixed(2)}</b> (æœ€ä¼˜åŠ¨ä½œ: ${ACTION_SYMBOLS[ACTIONS[bestIdx]]})`, 'l-res');
                
                resetOracle();
                stateIdx++;
                if(stateIdx >= 6) {
                    phase = 'DONE';
                    btnNext.textContent = "å®Œæˆæœ¬è½® ğŸ‰";
                } else {
                    phase = 'STATE';
                    btnNext.textContent = "ä¸‹ä¸€ä¸ªçŠ¶æ€ â­";
                }
                break;
                
            case 'DONE':
                // è®¡ç®—æ”¶æ•›æ€§: max|Î”V|
                maxDelta = 0;
                for(let i = 0; i < 6; i++) {
                    if(MODEL[i].type !== 'terminal') {
                        let delta = Math.abs(V_next[i] - V[i]);
                        if(delta > maxDelta) maxDelta = delta;
                    }
                }
                
                V = [...V_next]; // çœŸæ­£åŒæ­¥
                renderGrid(); // åˆ·æ–°æ˜¾ç¤º
                clearVisuals();
                updateConvergenceDisplay();
                
                if(maxDelta < EPSILON) {
                    isConverged = true;
                    addLog(`ğŸ‰ <span style="color:#2E7D32">å·²æ”¶æ•›! max|Î”V| = ${maxDelta.toFixed(4)} < Îµ = ${EPSILON}</span>`, 'l-res');
                    addLog(`ğŸ ç¬¬ ${iteration} è½®ç»“æŸï¼Œå€¼è¿­ä»£å®Œæˆï¼`, 'l-phase');
                    
                    // æ˜¾ç¤ºæœ€ä¼˜è§£
                    showOptimalSolution();
                    
                    btnNext.textContent = "âœ… å·²æ”¶æ•›";
                    btnNext.disabled = true;
                } else {
                    addLog(`ğŸ“Š max|Î”V| = <b>${maxDelta.toFixed(4)}</b> (é˜ˆå€¼ Îµ=${EPSILON})`, 'l-calc');
                    addLog(`ğŸ ç¬¬ ${iteration} è½®ç»“æŸï¼Œå°šæœªæ”¶æ•›ï¼Œç»§ç»­è¿­ä»£...`, 'l-phase');
                    btnNext.textContent = "å¼€å§‹ä¸‹ä¸€è½® â­";
                }
                iteration++;
                phase = 'INIT';
                break;
        }

        renderLogs();
        updateButtons();
    }

    function prev() {
        if (historyIndex <= 0) return;
        historyIndex--;
        restoreState(history[historyIndex]);
        renderGrid();
        renderLogs();
        clearVisuals();
        updateConvergenceDisplay();
        
        if (phase === 'ACTION' || phase === 'UPDATE' || phase === 'STATE') {
            highlightCell(stateIdx);
        }
        
        btnNext.textContent = "ä¸‹ä¸€æ­¥ â­";
        btnNext.disabled = false;
        updateButtons();
    }

    function reset() {
        stopAutoPlay();  // åœæ­¢è‡ªåŠ¨æ’­æ”¾
        V = Array(6).fill(0); V_next = Array(6).fill(0);
        stateIdx = 0; iteration = 1; phase = 'INIT';
        maxDelta = 0; isConverged = false;
        history = [];
        historyIndex = -1;
        btnNext.disabled = false;
        renderGrid();
        logs = [];
        resetOracle();
        btnNext.textContent = "ä¸‹ä¸€æ­¥ â­";
        init();
    }

    // --- UI è¾…åŠ© ---
    function updateOracle(s, a, nextS, r) {
        oracleCard.classList.add('querying');
        let futureV = MODEL[nextS].type === 'terminal' ? 0 : V[nextS];
        let terminalNote = MODEL[nextS].type === 'terminal' ? ' <span style="color:#9E9E9E">(ç»ˆæ­¢â†’0)</span>' : '';
        oracleContent.innerHTML = `
            <div>P(S${nextS} | S${s}, ${ACTION_SYMBOLS[a]}) = <span style="color:var(--c-p); font-weight:bold;">1.0</span></div>
            <div>R(S${s}, ${ACTION_SYMBOLS[a]}) = <span style="color:var(--c-r); font-weight:bold;">${r}</span></div>
            <div>V(S${nextS}) = <span style="color:var(--c-v); font-weight:bold;">${futureV.toFixed(2)}</span>${terminalNote}</div>
        `;
        oracleDesc.innerHTML = `ä» <b>S${s}</b> æ‰§è¡Œ <b>${ACTION_SYMBOLS[a]}</b> ç¡®å®šæ€§è½¬ç§»åˆ° <b>S${nextS}</b>`;
    }

    function showTerminalOracle(s) {
        oracleCard.classList.remove('querying');
        oracleContent.innerHTML = `<span style="color:#aaa">Terminal State (R=${MODEL[s].r})</span>`;
        oracleDesc.textContent = `S${s} æ˜¯ç»ˆç‚¹ï¼Œæ²¡æœ‰åç»­è½¬ç§»ï¼Œä»·å€¼å›ºå®šä¸ºå³æ—¶å¥–åŠ±ã€‚`;
    }

    function resetOracle() {
        oracleCard.classList.remove('querying');
        oracleContent.innerHTML = `<span style="color:#aaa">// ç­‰å¾…æŸ¥è¯¢...</span>`;
        oracleDesc.textContent = "å½“ç®—æ³•éå†åŠ¨ä½œæ—¶ï¼Œæ­¤å¤„æ˜¾ç¤º P å’Œ Rã€‚";
    }

    function addLog(html, type) {
        logs.push(`<div class="log-item ${type}">${html}</div>`);
    }

    function updateConvergenceDisplay() {
        const convDelta = document.getElementById('convDelta');
        const convStatus = document.getElementById('convStatus');
        
        if(iteration === 1 && maxDelta === 0) {
            convDelta.textContent = 'å½“å‰ max|Î”V| = --';
            convStatus.textContent = 'â³ ç­‰å¾…å¼€å§‹';
            convStatus.className = 'conv-status running';
        } else if(isConverged) {
            convDelta.textContent = `å½“å‰ max|Î”V| = ${maxDelta.toFixed(4)}`;
            convStatus.textContent = 'âœ… å·²æ”¶æ•›';
            convStatus.className = 'conv-status converged';
        } else {
            convDelta.textContent = `å½“å‰ max|Î”V| = ${maxDelta.toFixed(4)}`;
            convStatus.textContent = 'â³ è¿­ä»£ä¸­';
            convStatus.className = 'conv-status running';
        }
    }

    function highlightCell(i) {
        document.querySelectorAll('.cell').forEach(c => c.classList.remove('active'));
        document.getElementById(`cell-${i}`).classList.add('active');
    }
    function highlightArrow(s, a) {
        let map = {'UP':'arr-up','DOWN':'arr-down','LEFT':'arr-left','RIGHT':'arr-right'};
        document.querySelectorAll('.arr').forEach(arr => arr.classList.remove('active'));
        document.querySelector(`#cell-${s} .${map[a]}`).classList.add('active');
    }
    function clearVisuals() {
        document.querySelectorAll('.cell').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.arr').forEach(a => a.classList.remove('active'));
    }

    // --- æ˜¾ç¤ºæœ€ä¼˜è§£ ---
    function showOptimalSolution() {
        addLog(`<div style="margin-top:10px; padding:12px; background:#E8F5E9; border-radius:8px; border:2px solid #4CAF50;">
            <div style="font-weight:bold; color:#2E7D32; margin-bottom:10px; font-size:1.1rem;">ğŸ† æœ€ä¼˜è§£ (Optimal Solution)</div>
            <div style="margin-bottom:8px; font-weight:bold; color:#1976D2;">ğŸ“Š æœ€ä¼˜ä»·å€¼å‡½æ•° V*(s):</div>
            <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:5px; margin-bottom:12px;">
                ${MODEL.map((m, i) => `<span style="background:#fff; padding:4px 8px; border-radius:4px; text-align:center;">V*(S${i})=${V[i].toFixed(2)}</span>`).join('')}
            </div>
            <div style="font-weight:bold; color:#E91E63; margin-bottom:8px;">ğŸ¯ æœ€ä¼˜ç­–ç•¥ Ï€*(s):</div>
            <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:5px;">
                ${MODEL.map((m, i) => {
                    if(m.type === 'terminal') {
                        return `<span style="background:#EEEEEE; padding:4px 8px; border-radius:4px; text-align:center; color:#9E9E9E;">S${i}: ç»ˆæ­¢</span>`;
                    }
                    let bestAction = getBestAction(i);
                    return `<span style="background:#fff; padding:4px 8px; border-radius:4px; text-align:center;">Ï€*(S${i})=${ACTION_SYMBOLS[bestAction]}</span>`;
                }).join('')}
            </div>
        </div>`, 'l-res');
        
        // åœ¨æ ¼å­ä¸Šæ˜¾ç¤ºæœ€ä¼˜åŠ¨ä½œç®­å¤´
        renderOptimalPolicy();
    }

    function getBestAction(s) {
        let bestAction = ACTIONS[0];
        let bestQ = -Infinity;
        for(let a of ACTIONS) {
            let nextS = getNextState(s, a);
            let reward = MODEL[nextS].r;
            let futureV = MODEL[nextS].type === 'terminal' ? 0 : V[nextS];
            let q = reward + GAMMA * futureV;
            if(q > bestQ) {
                bestQ = q;
                bestAction = a;
            }
        }
        return bestAction;
    }

    function renderOptimalPolicy() {
        // é«˜äº®æ¯ä¸ªéç»ˆæ­¢çŠ¶æ€çš„æœ€ä¼˜åŠ¨ä½œç®­å¤´
        MODEL.forEach((m, i) => {
            if(m.type !== 'terminal') {
                let bestAction = getBestAction(i);
                let map = {'UP':'arr-up','DOWN':'arr-down','LEFT':'arr-left','RIGHT':'arr-right'};
                let arrow = document.querySelector(`#cell-${i} .${map[bestAction]}`);
                if(arrow) {
                    arrow.classList.add('active');
                    arrow.style.color = '#4CAF50';  // ç»¿è‰²è¡¨ç¤ºæœ€ä¼˜
                }
            }
        });
    }

    // --- è‡ªåŠ¨æ’­æ”¾åŠŸèƒ½ ---
    function toggleAutoPlay() {
        const btnAuto = document.getElementById('btnAuto');
        if(autoPlayTimer) {
            // åœæ­¢æ’­æ”¾
            clearInterval(autoPlayTimer);
            autoPlayTimer = null;
            btnAuto.textContent = 'â–¶ï¸ è‡ªåŠ¨æ’­æ”¾';
            btnAuto.classList.remove('playing');
        } else {
            // å¼€å§‹æ’­æ”¾
            if(isConverged) return; // å·²æ”¶æ•›ä¸æ’­æ”¾
            btnAuto.textContent = 'â¸ï¸ æš‚åœ';
            btnAuto.classList.add('playing');
            autoPlayTimer = setInterval(() => {
                if(isConverged || btnNext.disabled) {
                    stopAutoPlay();
                    return;
                }
                next();
            }, autoPlaySpeed);
        }
    }

    function stopAutoPlay() {
        const btnAuto = document.getElementById('btnAuto');
        if(autoPlayTimer) {
            clearInterval(autoPlayTimer);
            autoPlayTimer = null;
        }
        btnAuto.textContent = 'â–¶ï¸ è‡ªåŠ¨æ’­æ”¾';
        btnAuto.classList.remove('playing');
    }

    function updateSpeed() {
        const slider = document.getElementById('speedSlider');
        const label = document.getElementById('speedLabel');
        autoPlaySpeed = parseInt(slider.value);
        label.textContent = (autoPlaySpeed / 1000).toFixed(1) + 's';
        
        // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œé‡æ–°è®¾ç½®å®šæ—¶å™¨
        if(autoPlayTimer) {
            clearInterval(autoPlayTimer);
            autoPlayTimer = setInterval(() => {
                if(isConverged || btnNext.disabled) {
                    stopAutoPlay();
                    return;
                }
                next();
            }, autoPlaySpeed);
        }
    }

    init();
</script>

</body>
</html>
