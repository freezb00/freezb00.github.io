<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¨ å›¾ç‰‡è‰²å½©åˆ†æå·¥å…·</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Zcool+KuaiLe&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #fdfbf7;
            --card: #fffef9;
            --pink: #e5989b;
            --blue: #b5e2fa;
            --green: #d6e2e9;
            --yellow: #faedcd;
            --brown: #d4a373;
            --purple: #c3b1e1;
            --text: #6d6875;
            --line: #e5e5e5;
        }

        body {
            background-color: #f0efeb;
            font-family: "ZCOOL KuaiLe", cursive, sans-serif;
            margin: 0;
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text);
        }

        h1 {
            font-size: 48px;
            margin: 0 0 30px 0;
            color: var(--brown);
            text-shadow: 3px 3px 0 var(--yellow);
            text-align: center;
        }

        /* ç¬”è®°æœ¬å¡ç‰‡ */
        .note-card {
            width: 100%;
            max-width: 1400px;
            background-color: var(--card);
            position: relative;
            background-image:
                linear-gradient(var(--line) 1px, transparent 1px),
                linear-gradient(90deg, var(--line) 1px, transparent 1px);
            background-size: 25px 25px;
            box-shadow: 5px 5px 20px rgba(0, 0, 0, 0.08);
            padding: 40px;
            box-sizing: border-box;
            margin-bottom: 30px;
            border-radius: 5px;
            overflow: hidden;
        }

        /* èƒ¶å¸¦è£…é¥° */
        .tape {
            position: absolute;
            width: 100px;
            height: 30px;
            background-color: var(--pink);
            opacity: 0.7;
            top: -12px;
            left: 50%;
            transform: translateX(-50%) rotate(-2deg);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* æ‰‹ç»˜æ¡†æ¡† */
        .hand-box {
            border: 3px solid var(--brown);
            background: white;
            padding: 15px;
            margin: 15px 0;
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            position: relative;
            box-shadow: 3px 3px 0 rgba(0, 0, 0, 0.05);
        }

        /* è£…é¥°è´´çº¸ */
        .sticker {
            position: absolute;
            font-size: 35px;
            z-index: 10;
            filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.1));
        }

        /* ä¸»å†…å®¹å¸ƒå±€ */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 25px;
            margin-top: 20px;
        }

        /* å·¦ä¾§åŒºåŸŸ */
        .left-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* å›¾ç‰‡åŒºåŸŸ */
        .image-section h3 {
            font-size: 22px;
            margin: 0 0 15px 0;
            color: var(--text);
        }

        .tag {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 12px;
            color: white;
            margin-left: 8px;
            vertical-align: middle;
            background: var(--blue);
            color: #556;
        }

        /* å›¾ç‰‡å®¹å™¨ */
        .image-box {
            width: 100%;
            min-height: 420px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 2px dashed #ddd;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .image-box:hover {
            border-color: var(--brown);
            background: #fffef9;
        }

        .image-box.has-image {
            border-style: solid;
            border-color: #ccc;
            cursor: crosshair;
        }

        .image-box canvas {
            max-width: 100%;
            max-height: 360px;
            border-radius: 8px;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.08);
        }

        /* å›¾ç‰‡ä¸Šçš„ä½ç½®æ ‡è®° */
        .position-marker {
            position: absolute;
            width: 24px;
            height: 24px;
            border: 3px solid var(--brown);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 15;
            box-shadow: 0 0 0 3px rgba(255,255,255,0.8), 0 2px 8px rgba(0,0,0,0.3);
            animation: markerPulse 1.5s ease-in-out infinite;
        }

        .position-marker::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 8px;
            height: 8px;
            background: var(--brown);
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        @keyframes markerPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.8; }
        }

        /* è°ƒæ•´æç¤º */
        .adjusted-tip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            white-space: nowrap;
            margin-bottom: 8px;
            z-index: 20;
            display: none;
        }

        .adjusted-tip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(0,0,0,0.85);
        }

        .position-marker.adjusted .adjusted-tip {
            display: block;
        }

        .adjusted-tip .original-color {
            display: inline-block;
            width: 14px;
            height: 14px;
            border-radius: 3px;
            vertical-align: middle;
            margin-right: 5px;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .adjusted-tip .arrow {
            margin: 0 5px;
            opacity: 0.6;
        }

        .adjusted-tip .new-color {
            display: inline-block;
            width: 14px;
            height: 14px;
            border-radius: 3px;
            vertical-align: middle;
            margin-left: 5px;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .upload-hint {
            text-align: center;
            color: #aaa;
            padding: 20px;
        }

        .upload-hint svg {
            width: 50px;
            height: 50px;
            stroke: var(--brown);
            opacity: 0.5;
            margin-bottom: 10px;
        }

        .upload-hint p { font-size: 18px; margin-bottom: 5px; }
        .upload-hint small { font-size: 14px; color: #ccc; }

        .image-info {
            position: absolute;
            right: 2px;
            bottom: 10px;
            transform: translateX(-10%);
            font-size: 12px;
            color: #ca6f6f;
            background: rgba(252, 245, 245, 0.4);
            border-radius: 10px;
            z-index: 5;
        }

        /* æ›´æ¢å›¾ç‰‡æŒ‰é’® - å³ä¸Šè§’æ‚¬æµ® */
        .change-image-btn {
            display: none;
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 20;
            padding: 6px 14px;
            font-size: 13px;
            background: rgba(255, 255, 255, 0.95);
            color: var(--brown);
            border: 2px solid var(--brown);
            border-radius: 20px;
            cursor: pointer;
            font-family: inherit;
            box-shadow: 0 2px 8px rgba(0,0,0,0.01);
            transition: all 0.2s;
        }

        .change-image-btn:hover {
            background: var(--brown);
            color: white;
            transform: scale(1.05);
        }

        .change-image-btn.show {
            display: block;
        }

        .pick-hint {
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            color: #999;
        }

        #uploadInput { display: none; }

        /* è‰²è½®åŒºåŸŸ - æ”¾åœ¨å›¾ç‰‡ä¸‹æ–¹ */
        .color-wheel-section {
            background: white;
            border: 2px solid #eee;
            border-radius: 15px;
            padding: 20px;
        }

        .section-title {
            font-size: 20px;
            font-weight: bold;
            color: var(--brown);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .color-wheel-container {
            position: relative;
            width: 440px;
            height: 440px;
            margin: 0 auto;
        }

        .color-wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(
                #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000
            );
            position: relative;
            border: 4px solid var(--brown);
            box-shadow: 3px 3px 0 rgba(0,0,0,0.05);
        }

        .color-wheel::after {
            content: '';
            position: absolute;
            top: 20%;
            left: 20%;
            right: 20%;
            bottom: 20%;
            background: radial-gradient(circle, white 0%, transparent 70%);
            border-radius: 50%;
        }

        .wheel-marker {
            position: absolute;
            width: 16px;
            height: 16px;
            border: 3px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
            transition: all 0.15s;
            z-index: 10;
        }

        /* å®æ—¶é¢„è§ˆçš„è‰²ç‚¹ - é’è‰²è™šçº¿è¾¹æ¡† */
        .wheel-marker.preview {
            width: 20px;
            height: 20px;
            border: 3px dashed #00d4ff;
            opacity: 0.9;
            z-index: 25;
            box-shadow: 0 0 8px rgba(0, 212, 255, 0.5), 0 2px 6px rgba(0,0,0,0.4);
            animation: previewPulse 1s ease-in-out infinite;
        }

        @keyframes previewPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }

        /* å½“å‰é€‰ä¸­ç¼–è¾‘çš„è‰²ç‚¹ - æ£•è‰²å®çº¿è¾¹æ¡† + æ”¾å¤§ + å…‰æ™• */
        .wheel-marker.editing {
            width: 24px;
            height: 24px;
            border: 4px solid var(--brown);
            z-index: 20;
            box-shadow: 0 0 0 4px rgba(212, 163, 115, 0.5), 0 4px 12px rgba(0,0,0,0.4);
        }

        /* å·²æ‹¾å–ä½†æœªé€‰ä¸­çš„è‰²ç‚¹ - ç™½è‰²å®çº¿è¾¹æ¡† */
        .wheel-marker.picked {
            border: 3px solid rgba(255, 255, 255, 0.9);
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        /* å³ä¾§é¢æ¿ */
        .panel-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .panel-card {
            background: white;
            border: 2px solid #eee;
            border-radius: 15px;
            padding: 18px;
        }

        .panel-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--brown);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* å½“å‰é¢œè‰²é¢„è§ˆ */
        .current-color {
            display: flex;
            gap: 15px;
        }

        .color-preview {
            width: 90px;
            height: 90px;
            border-radius: 15px;
            background: #ddd;
            box-shadow: 3px 3px 0 rgba(0,0,0,0.05);
            border: 3px solid var(--brown);
            flex-shrink: 0;
        }

        .color-values {
            flex: 1;
            font-size: 14px;
        }

        .color-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dashed #eee;
        }

        .color-row:last-child { border-bottom: none; }

        .color-label { color: #999; }

        .color-value {
            font-family: 'Monaco', 'Consolas', monospace;
            color: var(--text);
            font-size: 13px;
        }

        /* è‰²å½©æ¡ */
        .color-bar-section { margin-top: 15px; }

        .bar-label {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }

        .color-bar {
            height: 24px;
            border-radius: 12px;
            position: relative;
            margin-bottom: 12px;
            border: 2px solid #eee;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .color-bar:hover {
            transform: scaleY(1.1);
            border-color: var(--brown);
        }

        .color-bar.active {
            border-color: var(--brown);
            box-shadow: 0 0 0 2px rgba(212, 163, 115, 0.3);
        }

        .hue-bar {
            background: linear-gradient(to right, 
                #ff0000 0%, #ffff00 17%, #00ff00 33%, 
                #00ffff 50%, #0000ff 67%, #ff00ff 83%, #ff0000 100%);
        }

        .saturation-bar {
            background: linear-gradient(to right, #808080 0%, #e5989b 100%);
        }

        .brightness-bar {
            background: linear-gradient(to right, #000000 0%, #ffffff 100%);
        }

        .bar-marker {
            position: absolute;
            width: 8px;
            height: 32px;
            top: -4px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            border: 2px solid var(--brown);
            transform: translateX(-50%);
            transition: left 0.1s;
            cursor: grab;
            pointer-events: none;
        }

        /* ç¼–è¾‘æç¤º */
        .edit-hint {
            font-size: 12px;
            color: #aaa;
            text-align: center;
            margin-top: 5px;
            display: none;
        }

        .edit-hint.show {
            display: block;
        }

        /* æ ‡ç­¾æŒ‰é’® */
        .color-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .color-tag {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            background: #f5f5f5;
            color: var(--text);
        }

        .color-tag:hover { transform: translateY(-1px); }

        .color-tag.light { background: rgba(255, 236, 153, 0.3); border-color: #ffd93d; }
        .color-tag.shadow { background: rgba(99, 102, 241, 0.15); border-color: #818cf8; }
        .color-tag.accent { background: rgba(244, 114, 182, 0.2); border-color: #f472b6; }

        /* å·²æ‹¾å–é¢œè‰² - æ›´å¤§çš„æ˜¾ç¤º */
        .picked-colors {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            min-height: 80px;
        }

        .picked-color-item {
            width: 70px;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: grab;
            transition: transform 0.2s;
            position: relative;
        }

        .picked-color-item:active { cursor: grabbing; }

        .picked-color-item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .picked-color-item.drag-over {
            transform: translateX(10px);
        }

        .picked-color-item:hover { transform: scale(1.05); }

        .picked-color-swatch {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            box-shadow: 2px 2px 0 rgba(0,0,0,0.08);
            border: 3px solid white;
            position: relative;
        }

        .picked-color-item.active .picked-color-swatch {
            border: 3px solid var(--brown);
        }

        .picked-color-swatch .remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            background: var(--pink);
            color: white;
            border-radius: 50%;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
            cursor: pointer;
            border: none;
        }

        .picked-color-item:hover .remove-btn { opacity: 1; }

        .picked-color-swatch .tag-icon {
            position: absolute;
            bottom: -4px;
            right: -4px;
            font-size: 16px;
        }

        .picked-color-swatch .adjusted-icon {
            position: absolute;
            top: -6px;
            left: -6px;
            font-size: 14px;
            background: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .picked-color-hsb {
            font-size: 11px;
            color: #666;
            margin-top: 6px;
            text-align: center;
            line-height: 1.5;
            font-family: 'Monaco', 'Consolas', monospace;
        }

        .picked-color-hsb div {
            white-space: nowrap;
        }

        .empty-hint {
            color: #ccc;
            font-size: 14px;
            text-align: center;
            padding: 20px;
            width: 100%;
        }

        /* æŒ‰é’® */
        button {
            background: var(--brown);
            color: white;
            border: none;
            padding: 0px 0px;
            border-radius: 50px;
            font-size: 14px;
            font-family: inherit;
            cursor: pointer;
            box-shadow: 0 3px 0 #a67c52;
            transition: all 0.1s;
        }

        button:hover { transform: translateY(1px); box-shadow: 0 2px 0 #a67c52; }
        button:active { transform: translateY(3px); box-shadow: none; }

        .btn-clear { background: var(--pink); box-shadow: 0 3px 0 #c47f82; }
        .btn-clear:hover { box-shadow: 0 2px 0 #c47f82; }

        /* æ”¾å¤§é•œ */
        .magnifier {
            position: fixed;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid var(--brown);
            pointer-events: none;
            display: none;
            z-index: 1000;
            overflow: hidden;
            box-shadow: 3px 3px 10px rgba(0,0,0,0.2);
            background: white;
        }

        .magnifier canvas { width: 100%; height: 100%; }

        .magnifier-crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            transform: translate(-50%, -50%);
            border: 2px solid rgba(0,0,0,0.5);
            border-radius: 50%;
        }

        /* å“åº”å¼ */
        @media (max-width: 1000px) {
            .main-layout { grid-template-columns: 1fr; }
            h1 { font-size: 36px; }
        }
    </style>
</head>
<body>

    <h1>ğŸ¨ å›¾ç‰‡è‰²å½©åˆ†æå·¥å…·</h1>

    <div class="note-card">
        <div class="tape"></div>
        <div class="sticker" style="top: 30px; right: 30px; transform: rotate(10deg);">ğŸ–Œï¸</div>
        <div class="sticker" style="top: 30px; left: 30px; transform: rotate(-5deg);">ğŸŒˆ</div>

        <div class="main-layout">
            <!-- å·¦ä¾§ï¼šå›¾ç‰‡ + è‰²è½® -->
            <div class="left-section">
                <!-- å›¾ç‰‡åŒºåŸŸ -->
                <div class="image-section">
                   
                    <div class="image-box" id="imageContainer">
                        <div class="upload-hint" id="uploadHint">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            <p>ç‚¹å‡» / æ‹–æ”¾ / ç²˜è´´</p>
                            <small>Ctrl+V ç²˜è´´æˆªå›¾</small>
                        </div>
                        <canvas id="imageCanvas" style="display: none;"></canvas>
                        <button class="change-image-btn" id="changeImageBtn">æ›´æ¢</button>
                    <div class="image-info" id="imageInfo" style="display: none;"></div>
                    </div>  
                    
                </div>

                <!-- è‰²è½® - ç§»åˆ°å›¾ç‰‡ä¸‹æ–¹ -->
                <div class="color-wheel-section">
                    <div class="section-title">ğŸŒˆ è‰²è½®ä½ç½®</div>
                    <div class="color-wheel-container">
                        <div class="color-wheel" id="colorWheel"></div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šåˆ†æé¢æ¿ -->
            <div class="panel-section">
                <!-- å½“å‰é¢œè‰² -->
                <div class="panel-card">
                    <div class="panel-title">ğŸ¯ å½“å‰é¢œè‰²</div>
                    <div class="current-color">
                        <div class="color-preview" id="colorPreview"></div>
                        <div class="color-values">
                            <div class="color-row">
                                <span class="color-label">HEX</span>
                                <span class="color-value" id="hexValue">#------</span>
                            </div>
                            <div class="color-row">
                                <span class="color-label">RGB</span>
                                <span class="color-value" id="rgbValue">---, ---, ---</span>
                            </div>
                            <div class="color-row">
                                <span class="color-label">HSB</span>
                                <span class="color-value" id="hsbValue">---Â°, ---%, ---%</span>
                            </div>
                            <div class="color-row">
                                <span class="color-label">CMYK</span>
                                <span class="color-value" id="cmykValue">--%, --%, --%, --%</span>
                            </div>
                        </div>
                    </div>

                    <!-- è‰²å½©æ¡ -->
                    <div class="color-bar-section">
                        <div class="bar-label">è‰²ç›¸ Hue</div>
                        <div class="color-bar hue-bar" id="hueBar">
                            <div class="bar-marker" id="hueMarker" style="left: 0%;"></div>
                        </div>

                        <div class="bar-label">é¥±å’Œåº¦ Saturation</div>
                        <div class="color-bar saturation-bar" id="satBar">
                            <div class="bar-marker" id="satMarker" style="left: 0%;"></div>
                        </div>

                        <div class="bar-label">æ˜åº¦ Brightness</div>
                        <div class="color-bar brightness-bar" id="briBar">
                            <div class="bar-marker" id="briMarker" style="left: 0%;"></div>
                        </div>

                        <p class="edit-hint" id="editHint">ğŸ’¡ é€‰ä¸­é¢œè‰²åå¯æ‹–åŠ¨è‰²æ¡è°ƒæ•´</p>
                        
                    </div>

                    <!-- æ ‡ç­¾ -->
                    <div class="color-tags">
                        <span class="color-tag light" onclick="tagColor('light')">â˜€ï¸ å…‰æºè‰²</span>
                        <span class="color-tag shadow" onclick="tagColor('shadow')">ğŸŒ™ é˜´å½±è‰²</span>
                        <span class="color-tag accent" onclick="tagColor('accent')">ğŸ’ é‡ç‚¹è‰²</span>
                    </div>
                </div>

                <!-- å·²æ‹¾å–é¢œè‰² -->
                <div class="panel-card">
                    <div class="panel-title" style="justify-content: space-between;">
                        <span>ğŸ“Œ å·²æ‹¾å–é¢œè‰²</span>
                        <button class="btn-clear" onclick="clearColors()" style="font-size: 12px; padding: 4px 12px;">æ¸…ç©º</button>
                    </div>
                    <p style="font-size: 12px; color: #aaa; margin: 0 0 10px 0;">å¯æ‹–æ‹½è°ƒæ•´é¡ºåºï¼Œç‚¹å‡»é¢œè‰²å¯ç¼–è¾‘</p>
                    <div class="picked-colors" id="pickedColors">
                        <div class="empty-hint">ç‚¹å‡»å›¾ç‰‡æ‹¾å–é¢œè‰²</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="uploadInput" accept="image/*">

    <!-- æ”¾å¤§é•œ -->
    <div class="magnifier" id="magnifier">
        <canvas id="magnifierCanvas" width="100" height="100"></canvas>
        <div class="magnifier-crosshair"></div>
    </div>

    <script>
        // DOM
        const uploadInput = document.getElementById('uploadInput');
        const uploadHint = document.getElementById('uploadHint');
        const imageCanvas = document.getElementById('imageCanvas');
        const imageContainer = document.getElementById('imageContainer');
        const imageInfo = document.getElementById('imageInfo');
        const changeImageBtn = document.getElementById('changeImageBtn');
        const magnifier = document.getElementById('magnifier');
        const magnifierCanvas = document.getElementById('magnifierCanvas');
        const colorWheel = document.getElementById('colorWheel');

        // è‰²å½©æ¡
        const hueBar = document.getElementById('hueBar');
        const satBar = document.getElementById('satBar');
        const briBar = document.getElementById('briBar');
        const editHint = document.getElementById('editHint');

        let pickedColors = [];
        let currentColor = null;
        let imageData = null;
        let canvasCtx = null;
        let hasImage = false;

        // æ‹–æ‹½æ’åºç›¸å…³
        let draggedItem = null;
        let draggedIndex = null;

        // å½“å‰ç¼–è¾‘çš„é¢œè‰²ç´¢å¼•
        let editingColorIndex = -1;

        // è‰²å½©æ¡æ‹–åŠ¨ç›¸å…³
        let isDraggingBar = false;
        let activeBar = null;

        // ä¸Šä¼ ç‚¹å‡»
        imageContainer.addEventListener('click', (e) => {
            if (!hasImage) {
                uploadInput.click();
            }
        });

        // æ‹–æ”¾ä¸Šä¼ 
        imageContainer.addEventListener('dragover', (e) => {
            e.preventDefault();
            imageContainer.style.borderColor = 'var(--brown)';
        });
        imageContainer.addEventListener('dragleave', () => {
            imageContainer.style.borderColor = '';
        });
        imageContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            imageContainer.style.borderColor = '';
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) handleImageUpload(file);
        });

        // ç²˜è´´
        document.addEventListener('paste', (e) => {
            const items = e.clipboardData?.items;
            if (!items) return;
            for (const item of items) {
                if (item.type.startsWith('image/')) {
                    e.preventDefault();
                    const file = item.getAsFile();
                    if (file) handleImageUpload(file);
                    break;
                }
            }
        });

        uploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleImageUpload(file);
        });

        changeImageBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            uploadInput.click();
        });

        function handleImageUpload(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const maxWidth = imageContainer.clientWidth - 20;
                    const maxHeight = 360;
                    let w = img.width, h = img.height;
                    
                    if (w > maxWidth) { h *= maxWidth / w; w = maxWidth; }
                    if (h > maxHeight) { w *= maxHeight / h; h = maxHeight; }
                    
                    imageCanvas.width = w;
                    imageCanvas.height = h;
                    canvasCtx = imageCanvas.getContext('2d');
                    canvasCtx.drawImage(img, 0, 0, w, h);
                    imageData = canvasCtx.getImageData(0, 0, w, h);

                    uploadHint.style.display = 'none';
                    imageCanvas.style.display = 'block';
                    imageContainer.classList.add('has-image');
                    imageInfo.style.display = 'block';
                    imageInfo.textContent = `${img.width} Ã— ${img.height} px`;
                    changeImageBtn.classList.add('show');
                    hasImage = true;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // ç”»å¸ƒäº‹ä»¶
        imageCanvas.addEventListener('mousemove', handleCanvasMove);
        imageCanvas.addEventListener('click', handleCanvasClick);
        imageCanvas.addEventListener('mouseleave', () => {
            magnifier.style.display = 'none';
        });

        function handleCanvasMove(e) {
            if (!imageData) return;
            
            const rect = imageCanvas.getBoundingClientRect();
            const x = Math.floor((e.clientX - rect.left) * (imageCanvas.width / rect.width));
            const y = Math.floor((e.clientY - rect.top) * (imageCanvas.height / rect.height));
            
            if (x < 0 || x >= imageCanvas.width || y < 0 || y >= imageCanvas.height) return;
            
            // è®°å½•å½“å‰ä½ç½®
            currentImgX = x;
            currentImgY = y;
            
            const color = getPixelColor(x, y);
            updateColorDisplay(color);
            updateMagnifier(e.clientX, e.clientY, x, y);
        }

        // å½“å‰é¼ æ ‡åœ¨å›¾ç‰‡ä¸Šçš„ä½ç½®
        let currentImgX = 0;
        let currentImgY = 0;

        function handleCanvasClick(e) {
            e.stopPropagation();
            if (currentColor) {
                // ä¿å­˜ä½ç½®ä¿¡æ¯å’ŒåŸå§‹é¢œè‰²
                addPickedColor({ 
                    ...currentColor, 
                    tag: null,
                    imgX: currentImgX,
                    imgY: currentImgY,
                    originalColor: { ...currentColor }  // ä¿å­˜åŸå§‹é¢œè‰²
                });
            }
        }

        function getPixelColor(x, y) {
            const index = (y * imageCanvas.width + x) * 4;
            return {
                r: imageData.data[index],
                g: imageData.data[index + 1],
                b: imageData.data[index + 2]
            };
        }

        function updateColorDisplay(color) {
            currentColor = color;
            const { r, g, b } = color;
            
            const hex = rgbToHex(r, g, b);
            const hsb = rgbToHsb(r, g, b);
            const cmyk = rgbToCmyk(r, g, b);
            
            document.getElementById('hexValue').textContent = hex;
            document.getElementById('rgbValue').textContent = `${r}, ${g}, ${b}`;
            document.getElementById('hsbValue').textContent = `${hsb.h}Â°, ${hsb.s}%, ${hsb.b}%`;
            document.getElementById('cmykValue').textContent = `${cmyk.c}%, ${cmyk.m}%, ${cmyk.y}%, ${cmyk.k}%`;
            document.getElementById('colorPreview').style.background = hex;
            
            document.getElementById('hueMarker').style.left = `${hsb.h / 360 * 100}%`;
            document.getElementById('satMarker').style.left = `${hsb.s}%`;
            document.getElementById('briMarker').style.left = `${hsb.b}%`;
            
            satBar.style.background = `linear-gradient(to right, #808080 0%, hsl(${hsb.h}, 100%, 50%) 100%)`;
            
            updateWheelMarker(hsb, hex);
        }

        function updateMagnifier(clientX, clientY, imgX, imgY) {
            magnifier.style.display = 'block';
            magnifier.style.left = `${clientX + 20}px`;
            magnifier.style.top = `${clientY - 50}px`;
            
            const magCtx = magnifierCanvas.getContext('2d');
            const size = 12;
            
            magCtx.imageSmoothingEnabled = false;
            magCtx.clearRect(0, 0, 100, 100);
            magCtx.drawImage(imageCanvas, imgX - size/2, imgY - size/2, size, size, 0, 0, 100, 100);
        }

        function updateWheelMarker(hsb, hex) {
            colorWheel.querySelectorAll('.wheel-marker.preview').forEach(m => m.remove());
            
            const wheelSize = colorWheel.offsetWidth || 440;
            const center = wheelSize / 2;
            const maxRadius = center - 10;
            const radius = (hsb.s / 100) * maxRadius;
            const angle = hsb.h * Math.PI / 180;
            
            const x = center + Math.cos(angle - Math.PI / 2) * radius;
            const y = center + Math.sin(angle - Math.PI / 2) * radius;
            
            const marker = document.createElement('div');
            marker.className = 'wheel-marker preview';
            marker.style.left = `${x}px`;
            marker.style.top = `${y}px`;
            marker.style.background = hex;
            colorWheel.appendChild(marker);
        }

        // ========== è‰²å½©æ¡æ‹–åŠ¨è°ƒæ•´ ==========
        function setupBarDrag(bar, type) {
            bar.addEventListener('mousedown', (e) => {
                if (editingColorIndex < 0) return;
                isDraggingBar = true;
                activeBar = type;
                bar.classList.add('active');
                updateColorFromBar(e, bar, type);
            });
        }

        document.addEventListener('mousemove', (e) => {
            if (!isDraggingBar || editingColorIndex < 0) return;
            const bar = document.getElementById(activeBar + 'Bar');
            updateColorFromBar(e, bar, activeBar);
        });

        document.addEventListener('mouseup', () => {
            if (isDraggingBar) {
                isDraggingBar = false;
                document.querySelectorAll('.color-bar').forEach(b => b.classList.remove('active'));
                activeBar = null;
            }
        });

        setupBarDrag(hueBar, 'hue');
        setupBarDrag(satBar, 'sat');
        setupBarDrag(briBar, 'bri');

        function updateColorFromBar(e, bar, type) {
            const rect = bar.getBoundingClientRect();
            let percent = (e.clientX - rect.left) / rect.width;
            percent = Math.max(0, Math.min(1, percent));
            
            const color = pickedColors[editingColorIndex];
            let hsb = color.hsb || rgbToHsb(color.r, color.g, color.b);
            
            if (type === 'hue') {
                hsb.h = Math.round(percent * 360);
            } else if (type === 'sat') {
                hsb.s = Math.round(percent * 100);
            } else if (type === 'bri') {
                hsb.b = Math.round(percent * 100);
            }
            
            const rgb = hsbToRgb(hsb.h, hsb.s, hsb.b);
            
            color.r = rgb.r;
            color.g = rgb.g;
            color.b = rgb.b;
            color.hsb = hsb;
            
            updateColorDisplay(color);
            renderPickedColors();
            
            // æ›´æ–°ä½ç½®æ ‡è®°æ˜¾ç¤ºï¼ˆæ˜¾ç¤ºè°ƒæ•´æç¤ºï¼‰
            showPositionMarker(color);
            
            // ä¿æŒé€‰ä¸­çŠ¶æ€
            setTimeout(() => {
                document.querySelectorAll('.picked-color-item').forEach((el, i) => {
                    el.classList.toggle('active', i === editingColorIndex);
                });
            }, 0);
        }

        // å·²æ‹¾å–é¢œè‰²
        function addPickedColor(color) {
            const hsb = rgbToHsb(color.r, color.g, color.b);
            color.hsb = hsb;
            pickedColors.push(color);
            renderPickedColors();
        }

        function removeColor(index, e) {
            e.stopPropagation();
            pickedColors.splice(index, 1);
            if (editingColorIndex === index) {
                editingColorIndex = -1;
                editHint.classList.remove('show');
                hidePositionMarker();
            } else if (editingColorIndex > index) {
                editingColorIndex--;
            }
            renderPickedColors();
        }

        function selectPickedColor(index) {
            editingColorIndex = index;
            currentColor = pickedColors[index];
            updateColorDisplay(currentColor);
            
            document.querySelectorAll('.picked-color-item').forEach((el, i) => {
                el.classList.toggle('active', i === index);
            });
            
            editHint.textContent = 'ğŸ¨ æ‹–åŠ¨ä¸Šæ–¹è‰²æ¡è°ƒæ•´é¢œè‰²';
            editHint.classList.add('show');
            
            // æ˜¾ç¤ºå›¾ç‰‡ä¸Šçš„ä½ç½®æ ‡è®°
            showPositionMarker(pickedColors[index]);
        }

        // æ˜¾ç¤º/æ›´æ–°ä½ç½®æ ‡è®°
        function showPositionMarker(color) {
            // ç§»é™¤æ—§æ ‡è®°
            const oldMarker = document.querySelector('.position-marker');
            if (oldMarker) oldMarker.remove();
            
            if (!color.imgX && color.imgX !== 0) return;
            
            // è®¡ç®—åœ¨ canvas æ˜¾ç¤ºåŒºåŸŸä¸­çš„ä½ç½®
            const rect = imageCanvas.getBoundingClientRect();
            const containerRect = imageContainer.getBoundingClientRect();
            
            const scaleX = rect.width / imageCanvas.width;
            const scaleY = rect.height / imageCanvas.height;
            
            const markerX = (rect.left - containerRect.left) + color.imgX * scaleX;
            const markerY = (rect.top - containerRect.top) + color.imgY * scaleY;
            
            // åˆ›å»ºæ ‡è®°
            const marker = document.createElement('div');
            marker.className = 'position-marker';
            marker.style.left = `${markerX}px`;
            marker.style.top = `${markerY}px`;
            marker.style.borderColor = rgbToHex(color.r, color.g, color.b);
            
            // æ£€æŸ¥é¢œè‰²æ˜¯å¦è¢«è°ƒæ•´è¿‡
            if (color.originalColor) {
                const orig = color.originalColor;
                if (orig.r !== color.r || orig.g !== color.g || orig.b !== color.b) {
                    marker.classList.add('adjusted');
                    
                    const origHex = rgbToHex(orig.r, orig.g, orig.b);
                    const newHex = rgbToHex(color.r, color.g, color.b);
                    
                    const tip = document.createElement('div');
                    tip.className = 'adjusted-tip';
                    tip.innerHTML = `
                        <span class="original-color" style="background:${origHex}"></span>
                        åŸè‰²
                        <span class="arrow">â†’</span>
                        å·²è°ƒæ•´
                        <span class="new-color" style="background:${newHex}"></span>
                    `;
                    marker.appendChild(tip);
                }
            }
            
            imageContainer.appendChild(marker);
        }

        // éšè—ä½ç½®æ ‡è®°
        function hidePositionMarker() {
            const marker = document.querySelector('.position-marker');
            if (marker) marker.remove();
        }

        function renderPickedColors() {
            const container = document.getElementById('pickedColors');
            
            if (pickedColors.length === 0) {
                container.innerHTML = '<div class="empty-hint">ç‚¹å‡»å›¾ç‰‡æ‹¾å–é¢œè‰²</div>';
                editingColorIndex = -1;
                editHint.classList.remove('show');
                renderAllWheelMarkers();
                return;
            }
            
            container.innerHTML = pickedColors.map((color, index) => {
                const hex = rgbToHex(color.r, color.g, color.b);
                const hsb = color.hsb || rgbToHsb(color.r, color.g, color.b);
                const tagIcon = color.tag === 'light' ? 'â˜€ï¸' : color.tag === 'shadow' ? 'ğŸŒ™' : color.tag === 'accent' ? 'ğŸ’' : '';
                const isActive = index === editingColorIndex;
                
                // æ£€æŸ¥æ˜¯å¦è¢«è°ƒæ•´è¿‡
                let isAdjusted = false;
                if (color.originalColor) {
                    const orig = color.originalColor;
                    isAdjusted = orig.r !== color.r || orig.g !== color.g || orig.b !== color.b;
                }
                
                return `
                    <div class="picked-color-item ${isActive ? 'active' : ''}" 
                         draggable="true"
                         data-index="${index}"
                         onclick="selectPickedColor(${index})">
                        <div class="picked-color-swatch" style="background: ${hex}">
                            <span class="remove-btn" onclick="removeColor(${index}, event)">Ã—</span>
                            ${isAdjusted ? '<span class="adjusted-icon">âœï¸</span>' : ''}
                            ${tagIcon ? `<span class="tag-icon">${tagIcon}</span>` : ''}
                        </div>
                        <div class="picked-color-hsb">
                            <div>H: ${hsb.h}Â°</div>
                            <div>S: ${hsb.s}%</div>
                            <div>B: ${hsb.b}%</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            bindDragEvents();
            renderAllWheelMarkers();
        }

        // æ‹–æ‹½æ’åº
        function bindDragEvents() {
            const items = document.querySelectorAll('.picked-color-item');
            
            items.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragleave', handleDragLeave);
            });
        }

        function handleDragStart(e) {
            draggedItem = this;
            draggedIndex = parseInt(this.dataset.index);
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.picked-color-item').forEach(item => {
                item.classList.remove('drag-over');
            });
            draggedItem = null;
            draggedIndex = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            if (this !== draggedItem) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            if (this === draggedItem) return;
            
            const targetIndex = parseInt(this.dataset.index);
            const [removed] = pickedColors.splice(draggedIndex, 1);
            pickedColors.splice(targetIndex, 0, removed);
            
            if (editingColorIndex === draggedIndex) {
                editingColorIndex = targetIndex;
            } else if (draggedIndex < editingColorIndex && targetIndex >= editingColorIndex) {
                editingColorIndex--;
            } else if (draggedIndex > editingColorIndex && targetIndex <= editingColorIndex) {
                editingColorIndex++;
            }
            
            renderPickedColors();
        }

        function tagColor(tag) {
            if (currentColor) {
                const existing = pickedColors.findIndex(c => 
                    c.r === currentColor.r && c.g === currentColor.g && c.b === currentColor.b
                );
                
                if (existing >= 0) {
                    // å¦‚æœå·²æœ‰ç›¸åŒæ ‡ç­¾ï¼Œåˆ™å–æ¶ˆæ ‡ç­¾ï¼›å¦åˆ™è®¾ç½®æ–°æ ‡ç­¾
                    if (pickedColors[existing].tag === tag) {
                        pickedColors[existing].tag = null;
                    } else {
                        pickedColors[existing].tag = tag;
                    }
                } else {
                    const hsb = rgbToHsb(currentColor.r, currentColor.g, currentColor.b);
                    addPickedColor({ ...currentColor, tag, hsb });
                    return;
                }
                renderPickedColors();
            }
        }

        function renderAllWheelMarkers() {
            colorWheel.querySelectorAll('.wheel-marker:not(.preview)').forEach(m => m.remove());
            
            const wheelSize = colorWheel.offsetWidth || 440;
            const center = wheelSize / 2;
            const maxRadius = center - 10;
            
            pickedColors.forEach((color, index) => {
                const hsb = color.hsb || rgbToHsb(color.r, color.g, color.b);
                const angle = hsb.h * Math.PI / 180;
                const radius = (hsb.s / 100) * maxRadius;
                
                const x = center + Math.cos(angle - Math.PI / 2) * radius;
                const y = center + Math.sin(angle - Math.PI / 2) * radius;
                
                const marker = document.createElement('div');
                
                // æ ¹æ®çŠ¶æ€è®¾ç½®ä¸åŒçš„ class
                if (index === editingColorIndex) {
                    marker.className = 'wheel-marker editing';
                } else {
                    marker.className = 'wheel-marker picked';
                }
                
                marker.style.left = `${x}px`;
                marker.style.top = `${y}px`;
                marker.style.background = rgbToHex(color.r, color.g, color.b);
                
                // æ ‡ç­¾é¢œè‰²è¦†ç›–è¾¹æ¡†ï¼ˆä»…å¯¹å·²æ‹¾å–æœªé€‰ä¸­çš„ï¼‰
                if (index !== editingColorIndex) {
                    if (color.tag === 'light') marker.style.borderColor = '#ffd93d';
                    else if (color.tag === 'shadow') marker.style.borderColor = '#818cf8';
                    else if (color.tag === 'accent') marker.style.borderColor = '#f472b6';
                }
                
                colorWheel.appendChild(marker);
            });
        }

        function clearColors() {
            pickedColors = [];
            editingColorIndex = -1;
            editHint.classList.remove('show');
            hidePositionMarker();
            renderPickedColors();
        }

        // é¢œè‰²è½¬æ¢
        function rgbToHex(r, g, b) {
            return '#' + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('').toUpperCase();
        }

        function rgbToHsb(r, g, b) {
            r /= 255; g /= 255; b /= 255;
            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            const d = max - min;
            
            let h = 0;
            if (d !== 0) {
                switch (max) {
                    case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
                    case g: h = ((b - r) / d + 2) / 6; break;
                    case b: h = ((r - g) / d + 4) / 6; break;
                }
            }
            
            return {
                h: Math.round(h * 360),
                s: Math.round((max === 0 ? 0 : d / max) * 100),
                b: Math.round(max * 100)
            };
        }

        function rgbToCmyk(r, g, b) {
            if (r === 0 && g === 0 && b === 0) return { c: 0, m: 0, y: 0, k: 100 };
            
            r /= 255; g /= 255; b /= 255;
            const k = 1 - Math.max(r, g, b);
            
            return {
                c: Math.round((1 - r - k) / (1 - k) * 100),
                m: Math.round((1 - g - k) / (1 - k) * 100),
                y: Math.round((1 - b - k) / (1 - k) * 100),
                k: Math.round(k * 100)
            };
        }

        function hsbToRgb(h, s, b) {
            s /= 100;
            b /= 100;
            
            const c = b * s;
            const x = c * (1 - Math.abs((h / 60) % 2 - 1));
            const m = b - c;
            
            let r = 0, g = 0, bl = 0;
            
            if (h >= 0 && h < 60) { r = c; g = x; bl = 0; }
            else if (h >= 60 && h < 120) { r = x; g = c; bl = 0; }
            else if (h >= 120 && h < 180) { r = 0; g = c; bl = x; }
            else if (h >= 180 && h < 240) { r = 0; g = x; bl = c; }
            else if (h >= 240 && h < 300) { r = x; g = 0; bl = c; }
            else { r = c; g = 0; bl = x; }
            
            return {
                r: Math.round((r + m) * 255),
                g: Math.round((g + m) * 255),
                b: Math.round((bl + m) * 255)
            };
        }
    </script>
</body>
</html>
