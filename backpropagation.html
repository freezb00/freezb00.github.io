<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç¥ç»ç½‘ç»œåå‘ä¼ æ’­ä¹‹æ—… âœ¨</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Balsamiq+Sans:wght@400;700&family=ZCOOL+KuaiLe&display=swap');

        :root {
            /* æ¸©æš–æ²»æ„ˆé…è‰² */
            --bg-paper: #FFF8E7;
            --grid-line: #FFE4C4;
            --ink-color: #5D4E37;
            --border-color: #8B7355;
            --accent-color: #FF7043;
            --accent-light: #FFAB91;
            --shadow: rgba(139, 115, 85, 0.2);
            
            /* èŠ‚ç‚¹é…è‰² */
            --input-bg: #E8F5E9;
            --input-border: #81C784;
            --hidden-bg: #EDE7F6;
            --hidden-border: #B39DDB;
            --output-bg: #FCE4EC;
            --output-border: #F48FB1;
            
            /* è¿çº¿é…è‰² - å‰å‘ä¼ æ’­ */
            --line-color: #D7CCC8;
            --line-hover: #A1887F;
            
            /* åå‘ä¼ æ’­ç®­å¤´ - æ·±ç´«è‰²ç³»ï¼ˆä¸éšè—å±‚å‘¼åº”ï¼‰ */
            --backprop-color: #8763c5;
            --backprop-light: #D1C4E9;
            
            --node-r: 32px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: 'Balsamiq Sans', 'ZCOOL KuaiLe', cursive;
            background-color: var(--bg-paper);
            background-image: 
                linear-gradient(var(--grid-line) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
            background-size: 20px 20px;
            color: var(--ink-color);
            overflow: hidden;
            user-select: none;
            display: flex;
            flex-direction: column;
        }

        /* === é¡¶éƒ¨å·¥å…·æ  === */
        .toolbar {
            height: 70px;
            padding: 0 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.9);
            border-bottom: 3px solid var(--border-color);
            box-shadow: 0 4px 0 var(--shadow);
            z-index: 100;
        }

        .title-area {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .title-area h1 {
            margin: 0;
            font-size: 24px;
            color: var(--accent-color);
            text-shadow: 2px 2px 0 var(--grid-line);
        }

        .title-area .subtitle {
            font-size: 14px;
            color: var(--ink-color);
            opacity: 0.7;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        button {
            padding: 10px 20px;
            border-radius: 12px 18px 14px 16px;
            border: 2px solid var(--border-color);
            background: white;
            cursor: pointer;
            font-weight: bold;
            font-family: inherit;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            box-shadow: 3px 3px 0 var(--shadow);
            color: var(--ink-color);
        }

        button:hover:not(:disabled) {
            background: var(--accent-light);
            transform: translateY(-2px);
        }

        button:active:not(:disabled) {
            transform: translate(3px, 3px);
            box-shadow: none;
        }

        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .btn-play {
            background: var(--accent-color);
            border-color: #E64A19;
            color: white;
        }

        .btn-play:hover:not(:disabled) {
            background: #FF8A65;
        }

        .btn-help {
            background: #FFF9C4;
            border-color: #FBC02D;
            color: #F57F17;
        }

        /* === ä¸»ç”»å¸ƒåŒºåŸŸ === */
        .canvas-area {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        svg#network-svg {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        /* SVG è¿çº¿æ ·å¼ - å‰å‘ä¼ æ’­ç”¨æµ…å’–è‰² */
        .connection-line {
            fill: none;
            stroke: var(--line-color);
            stroke-width: 3;
            stroke-linecap: round;
            cursor: pointer;
            transition: all 0.3s;
        }

        .connection-line:hover {
            stroke: var(--line-hover);
            stroke-width: 5;
            filter: drop-shadow(0 0 6px var(--line-hover));
        }

        .connection-line.active {
            stroke: var(--accent-color);
            stroke-width: 5;
            filter: drop-shadow(0 0 10px var(--accent-color));
        }

        /* è¿çº¿æ ‡ç­¾ */
        .line-label {
            position: absolute;
            background: white;
            border: 2px solid var(--accent-color);
            border-radius: 8px;
            padding: 4px 10px;
            font-size: 13px;
            font-weight: bold;
            color: var(--accent-color);
            pointer-events: none;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.2s;
            z-index: 50;
            box-shadow: 2px 2px 0 var(--shadow);
        }

        .line-label.visible {
            opacity: 1;
            transform: scale(1);
        }

        /* èŠ‚ç‚¹æ ·å¼ */
        .node {
            position: absolute;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 4px 4px 0 var(--shadow);
        }

        .node:hover {
            transform: scale(1.15);
            z-index: 60;
        }

        .node.active {
            transform: scale(1.2);
            z-index: 60;
        }

        .node .node-label {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 2px;
        }

        .node.layer-input {
            background: var(--input-bg);
            border: 3px solid var(--input-border);
        }

        .node.layer-hidden {
            background: var(--hidden-bg);
            border: 3px solid var(--hidden-border);
        }

        .node.layer-output {
            background: var(--output-bg);
            border: 3px solid var(--output-border);
        }

        /* å±‚æ ‡ç­¾ */
        .layer-tag {
            position: absolute;
            font-size: 14px;
            font-weight: bold;
            color: var(--ink-color);
            opacity: 0.5;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-align: center;
            width: 120px;
        }

        /* Loss èŠ‚ç‚¹ */
        .loss-node {
            position: absolute;
            width: 80px;
            height: 50px;
            background: linear-gradient(135deg, #FFCCBC 0%, #FFAB91 100%);
            border: 3px solid var(--accent-color);
            border-radius: 15px 25px 15px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 16px;
            color: #BF360C;
            box-shadow: 4px 4px 0 var(--shadow);
        }

        /* === åº•éƒ¨æ¨å¯¼åŒºåŸŸ === */
        .derivation-panel {
            height: 260px;
            background: rgba(255, 255, 255, 0.95);
            border-top: 3px solid var(--border-color);
            box-shadow: 0 -4px 0 var(--shadow);
            display: flex;
            flex-direction: column;
            z-index: 100;
        }

        .panel-header {
            padding: 12px 25px;
            border-bottom: 2px dashed var(--grid-line);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-size: 16px;
            font-weight: bold;
            color: var(--accent-color);
        }

        .panel-hint {
            font-size: 13px;
            color: var(--ink-color);
            opacity: 0.6;
        }

        .panel-content {
            flex: 1;
            padding: 15px 25px;
            overflow-x: auto;
            overflow-y: auto;
            display: flex;
            gap: 16px;
            align-items: flex-start;
        }

        /* æ¨å¯¼æ­¥éª¤å¡ç‰‡ */
        .step-card {
            background: white;
            border: 2px solid var(--border-color);
            border-left-width: 5px;
            border-left-color: var(--backprop-color);
            border-radius: 8px 15px 12px 10px;
            padding: 12px 16px;
            min-width: 280px;
            max-width: 400px;
            box-shadow: 3px 3px 0 var(--shadow);
            opacity: 0;
            transform: translateY(20px) rotate(-1deg);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            flex-shrink: 0;
            overflow-x: auto;
        }

        .step-card.visible {
            opacity: 1;
            transform: translateY(0) rotate(0deg);
        }

        .step-card.current {
            border-left-color: var(--accent-color);
            background: linear-gradient(135deg, #FFF9E6 0%, #FFF3E0 100%);
            box-shadow: 0 0 0 3px var(--accent-light), 6px 6px 0 var(--shadow);
            transform: scale(1.02);
        }

        .step-badge {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 26px;
            height: 26px;
            background: var(--backprop-color);
            color: white;
            border-radius: 50%;
            font-size: 13px;
            font-weight: bold;
            margin-right: 10px;
            box-shadow: 2px 2px 0 rgba(38, 166, 154, 0.3);
        }

        .step-title {
            font-weight: bold;
            color: var(--ink-color);
            margin-bottom: 8px;
        }

        .step-math {
            font-size: 14px;
            color: #37474F;
            line-height: 1.8;
        }

        .step-math .formula-line {
            display: block;
            margin: 4px 0;
        }

        /* å¯ç‚¹å‡»çš„æ•°å­¦ç¬¦å· */
        .clickable-symbol {
            cursor: pointer;
            border-bottom: 2px dashed var(--backprop-color);
            padding-bottom: 1px;
            transition: all 0.2s;
        }

        .clickable-symbol:hover {
            background: var(--backprop-light);
            border-radius: 4px;
        }

        .floating-formula {
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #8763c5;
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            max-width: none;
            white-space: nowrap;
            font-size: 24px;
            pointer-events: auto;
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(10px);
        }
        .floating-formula.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* === ç¬¦å·è§£é‡Šå¼¹çª— === */
        .symbol-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .symbol-popup-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .symbol-popup {
            position: absolute;
            background: white;
            border: 3px solid var(--backprop-color);
            border-radius: 15px 25px 18px 20px;
            padding: 20px;
            width: 340px;
            box-shadow: 8px 8px 0 var(--shadow);
            transform: scale(0.8) rotate(-2deg);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .symbol-popup-overlay.visible .symbol-popup {
            transform: scale(1) rotate(0deg);
        }

        .popup-symbol {
            font-size: 28px;
            font-weight: bold;
            color: var(--backprop-color);
            margin-bottom: 8px;
        }

        .popup-name {
            font-size: 18px;
            font-weight: bold;
            color: var(--ink-color);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px dashed var(--grid-line);
        }

        .popup-explain {
            font-size: 14px;
            color: var(--ink-color);
            margin-bottom: 12px;
            line-height: 1.6;
        }

        .popup-analogy {
            background: #EDE7F6;
            border: 2px solid var(--backprop-color);
            border-radius: 10px;
            padding: 10px 14px;
            font-size: 13px;
            color: #4527A0;
        }

        .popup-analogy::before {
            content: "ğŸ’¡ ";
        }

        .popup-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 20px;
            cursor: pointer;
            color: var(--ink-color);
            opacity: 0.5;
            transition: all 0.2s;
        }

        .popup-close:hover {
            opacity: 1;
            transform: scale(1.2);
        }

        /* è£…é¥°å…ƒç´  */
        .deco-star {
            position: absolute;
            font-size: 20px;
            opacity: 0.3;
            pointer-events: none;
        }

        /* åå‘ä¼ æ’­ç®­å¤´ - é’ç»¿è‰² */
        .backprop-arrow {
            fill: none;
            stroke: var(--backprop-color);
            stroke-width: 3;
            stroke-linecap: round;
            stroke-linejoin: round;
            stroke-dasharray: 8, 4;
            opacity: 0;
            animation: backpropDash 0.8s forwards ease-out;
        }

        @keyframes backpropDash {
            0% { 
                opacity: 0;
                stroke-dashoffset: 100;
            }
            100% { 
                opacity: 1;
                stroke-dashoffset: 0;
            }
        }

        /* æ¬¢è¿æç¤º - é¡¶éƒ¨æ¨ªå¹… */
        .welcome-hint {
            position: absolute;
            top: 30px;
            left: 80%;
            transform: translateX(-50%);
            background: linear-gradient(90deg, #EDE7F6 0%, #D1C4E9 100%);
            border: 2px solid var(--backprop-color);
            border-radius: 30px;
            padding: 10px 25px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #4527A0;
            font-size: 14px;
            box-shadow: 3px 3px 0 var(--shadow);
            transition: all 0.5s;
            z-index: 50;
        }

        .welcome-hint.hidden {
            opacity: 0;
            transform: translateX(-50%) translateY(-20px);
            pointer-events: none;
        }

        .welcome-hint .hint-icon {
            font-size: 24px;
        }

        .welcome-hint .hint-text {
            font-size: 14px;
        }
        
        .welcome-hint .close-hint {
            cursor: pointer;
            opacity: 0.6;
            font-size: 16px;
            margin-left: 10px;
        }
        
        .welcome-hint .close-hint:hover {
            opacity: 1;
        }

        /* å›¾ä¾‹ */
        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255,255,255,0.9);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 10px 15px;
            font-size: 12px;
            box-shadow: 3px 3px 0 var(--shadow);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 4px 0;
        }

        .legend-line {
            width: 30px;
            height: 3px;
            border-radius: 2px;
        }

        .legend-line.forward {
            background: var(--line-color);
        }

        .legend-line.backward {
            background: var(--backprop-color);
            background: repeating-linear-gradient(
                90deg,
                var(--backprop-color) 0px,
                var(--backprop-color) 6px,
                transparent 6px,
                transparent 10px
            );
        }

        mjx-container { font-size: 105% !important; }
    </style>
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>

<!-- é¡¶éƒ¨å·¥å…·æ  -->
<div class="toolbar">
    <div class="title-area">
        <h1>ç¥ç»ç½‘ç»œåå‘ä¼ æ’­ä¹‹æ—…</h1>
        <span class="subtitle">ç‚¹å‡»è¿çº¿æˆ–èŠ‚ç‚¹ï¼Œå¼€å§‹æ¢ç´¢æ¢¯åº¦çš„å¥¥ç§˜ âœ¨</span>
    </div>
    <div class="btn-group">
        <button id="btn-prev" disabled>â® ä¸Šä¸€æ­¥</button>
        <button id="btn-play" class="btn-play">â–¶ è‡ªåŠ¨æ’­æ”¾</button>
        <button id="btn-next" disabled>ä¸‹ä¸€æ­¥ â­</button>
        <button id="btn-help" class="btn-help">â“ å¸®åŠ©</button>
    </div>
</div>

<!-- ä¸»ç”»å¸ƒ -->
<div class="canvas-area" id="canvas-area">
    <svg id="network-svg">
        <defs>
            <!-- å‰å‘ä¼ æ’­ç®­å¤´ - æµ…å’–è‰² -->
            <marker id="arrow-forward" markerWidth="10" markerHeight="10" refX="8" refY="4" orient="auto">
                <path d="M0,0 L0,8 L10,4 z" fill="#A1887F" />
            </marker>
            <!-- åå‘ä¼ æ’­ç®­å¤´ - é’ç»¿è‰² -->
            <marker id="arrow-backprop" markerWidth="12" markerHeight="12" refX="10" refY="6" orient="auto">
                <path d="M2,2 L10,6 L2,10 Q4,6 2,2 Z" fill="#8763c5" />
            </marker>
        </defs>
        <g id="connections-layer"></g>
        <g id="arrows-layer"></g>
    </svg>
    
    <div id="nodes-layer"></div>
    <div id="labels-layer"></div>
    
    <!-- å›¾ä¾‹ -->
    <div class="legend">
        <div class="legend-item">
            <div class="legend-line forward"></div>
            <span>å‰å‘ä¼ æ’­è¿æ¥</span>
        </div>
        <div class="legend-item">
            <div class="legend-line backward"></div>
            <span>åå‘ä¼ æ’­è·¯å¾„</span>
        </div>
    </div>
    
    <!-- æ¬¢è¿æç¤º -->
    <div class="welcome-hint" id="welcome-hint">
        <div class="hint-icon">ğŸ‘†</div>
        <div class="hint-text">ç‚¹å‡»ä»»æ„ <b>è¿çº¿</b> æŸ¥çœ‹æƒé‡æ›´æ–°<br>ç‚¹å‡»ä»»æ„ <b>èŠ‚ç‚¹</b> æŸ¥çœ‹åç½®æ›´æ–°</div>
    </div>
</div>

<!-- åº•éƒ¨æ¨å¯¼é¢æ¿ -->
<div class="derivation-panel">
    <div class="panel-header">
        <div class="panel-title" id="panel-title">é€‰æ‹©ä¸€ä¸ªå‚æ•°å¼€å§‹å­¦ä¹ </div>
        <div class="panel-hint">ç‚¹å‡»å…¬å¼ä¸­çš„ <span style="border-bottom: 2px dashed #8763c5;">è™šçº¿ç¬¦å·</span> æŸ¥çœ‹è§£é‡Š</div>
    </div>
    <div class="panel-content" id="panel-content">
        <!-- æ¨å¯¼æ­¥éª¤å¡ç‰‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
    </div>
</div>

<!-- ç¬¦å·è§£é‡Šå¼¹çª— -->
<div class="symbol-popup-overlay" id="symbol-overlay">
    <div class="symbol-popup" id="symbol-popup">
        <span class="popup-close" onclick="closeSymbolPopup()">âœ•</span>
        <div class="popup-symbol" id="popup-symbol"></div>
        <div class="popup-name" id="popup-name"></div>
        <div class="popup-explain" id="popup-explain"></div>
        <div class="popup-analogy" id="popup-analogy"></div>
    </div>
</div>

<!-- è¿çº¿æ‚¬æµ®æ ‡ç­¾ -->
<div class="line-label" id="line-label"></div>

<script>
    // ========== é…ç½® - ç½‘ç»œä½ç½®å±…ä¸­ ==========
    const LAYOUT = {
        input:  { x: 420, startY: 160, gap: 140 },
        hidden: { x: 640, startY: 130, gap: 110 },
        output: { x: 860, startY: 160, gap: 140 },
        loss:   { x: 1080, y: 230 }
    };
    const NODE_R = 32;

    // ========== ç¬¦å·å­—å…¸ ==========
    const symbolDict = {
        'partial': {
            symbol: 'âˆ‚',
            name: 'åå¯¼æ•°ç¬¦å·',
            explain: 'è¡¨ç¤º"åªå¯¹ä¸€ä¸ªå˜é‡æ±‚å¯¼ï¼ŒæŠŠå…¶ä»–å˜é‡å½“å¸¸æ•°"ã€‚åœ¨å¤šå˜é‡å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ä¸€æ¬¡åªå…³å¿ƒä¸€ä¸ªæ–¹å‘çš„å˜åŒ–ç‡ã€‚',
            analogy: 'åƒåœ¨å±±ä¸Šåªçœ‹ä¸œè¥¿æ–¹å‘çš„å¡åº¦ï¼Œæš‚æ—¶å¿½ç•¥å—åŒ—æ–¹å‘ã€‚'
        },
        'gradient': {
            symbol: 'âˆ‚L/âˆ‚w',
            name: 'æŸå¤±å¯¹æƒé‡çš„æ¢¯åº¦',
            explain: 'è¡¨ç¤º"å¦‚æœæˆ‘ç¨å¾®è°ƒæ•´è¿™ä¸ªæƒé‡ï¼ŒæŸå¤±ä¼šå¦‚ä½•å˜åŒ–"ã€‚æ­£å€¼è¡¨ç¤ºæƒé‡å¢å¤§ä¼šè®©è¯¯å·®å˜å¤§ï¼Œè´Ÿå€¼åˆ™ç›¸åã€‚',
            analogy: 'åƒè°ƒèŠ‚éŸ³é‡æ—‹é’®ï¼Œè¿™ä¸ªæ•°å‘Šè¯‰ä½ å¾€å“ªè¾¹æ‹§èƒ½è®©å£°éŸ³æ›´åˆé€‚ã€‚'
        },
        'delta': {
            symbol: 'Î´ (delta)',
            name: 'è¯¯å·®ä¿¡å· / å±€éƒ¨æ¢¯åº¦',
            explain: 'è¡¨ç¤º"è¿™ä¸ªç¥ç»å…ƒåº”è¯¥æ‰¿æ‹…å¤šå°‘è´£ä»»"ã€‚å®ƒæŠŠæ€»è¯¯å·®æŒ‰è´¡çŒ®æ¯”ä¾‹åˆ†é…ç»™æ¯ä¸ªç¥ç»å…ƒã€‚',
            analogy: 'åƒåˆ†æ‘Šè´¦å•ï¼Œæ ¹æ®æ¯äººç‚¹äº†å¤šå°‘æ¥å†³å®šå„ä»˜å¤šå°‘é’±ã€‚'
        },
        'eta': {
            symbol: 'Î· (eta)',
            name: 'å­¦ä¹ ç‡',
            explain: 'æ§åˆ¶æ¯æ¬¡æ›´æ–°å‚æ•°çš„æ­¥é•¿å¤§å°ã€‚å¤ªå¤§ä¼šè·³è¿‡æœ€ä¼˜è§£ï¼Œå¤ªå°åˆ™å­¦ä¹ å¤ªæ…¢ã€‚',
            analogy: 'åƒä¸‹å±±æ—¶æ¯ä¸€æ­¥è¿ˆå¤šå¤§ã€‚æ­¥å­å¤ªå¤§å¯èƒ½æ‘”è·¤ï¼Œå¤ªå°åˆ™èµ°å¾—å¤ªæ…¢ã€‚'
        },
        'fprime': {
            symbol: "f'(z) / I(z>0)",
            name: 'æ¿€æ´»å‡½æ•°çš„å¯¼æ•°',
            explain: 'è¡¨ç¤ºä¿¡å·é€šè¿‡ç¥ç»å…ƒæ—¶çš„"æ”¾å¤§æˆ–ç¼©å°ç³»æ•°"ã€‚åœ¨ReLUä¸­ï¼Œz>0æ—¶å¯¼æ•°ä¸º1ï¼Œzâ‰¤0æ—¶å¯¼æ•°ä¸º0ï¼Œè®°ä½œI(z>0)ã€‚',
            analogy: 'åƒéŸ³é‡è°ƒèŠ‚å™¨çš„çµæ•åº¦ï¼Œå†³å®šäº†è½¬åŠ¨æ—‹é’®æ—¶éŸ³é‡å˜åŒ–æœ‰å¤šå¿«ã€‚'
        },
        'loss': {
            symbol: 'L = Â½Î£(o-Å·)Â²',
            name: 'å‡æ–¹è¯¯å·®æŸå¤±å‡½æ•° (MSE)',
            explain: 'è¡¡é‡é¢„æµ‹å€¼oå’ŒçœŸå®å€¼Å·ä¹‹é—´å·®è·çš„å¹³æ–¹å’Œã€‚é™¤ä»¥2æ˜¯ä¸ºäº†æ±‚å¯¼æ—¶ç³»æ•°å¥½çœ‹ã€‚næ˜¯æ ·æœ¬æ•°ã€‚',
            analogy: 'åƒè€ƒè¯•åˆ†æ•°å’Œæ»¡åˆ†ä¹‹é—´çš„å·®è·çš„å¹³æ–¹ï¼Œæ”¾å¤§äº†å¤§è¯¯å·®çš„æƒ©ç½šã€‚'
        },
        'chain': {
            symbol: 'é“¾å¼æ³•åˆ™',
            name: 'é“¾å¼æ³•åˆ™ (Chain Rule)',
            explain: 'å¤åˆå‡½æ•°æ±‚å¯¼çš„è§„åˆ™ï¼šâˆ‚L/âˆ‚w = âˆ‚L/âˆ‚o Â· âˆ‚o/âˆ‚z Â· âˆ‚z/âˆ‚wã€‚æŠŠå¤æ‚æ±‚å¯¼æ‹†æˆå¤šä¸ªç®€å•éƒ¨åˆ†ç›¸ä¹˜ã€‚',
            analogy: 'åƒå¤šç±³è¯ºéª¨ç‰Œï¼Œæ¯ä¸€å¼ ç‰Œçš„å€’ä¸‹é€Ÿåº¦å–å†³äºå‰ä¸€å¼ æ¨å®ƒçš„åŠ›åº¦ã€‚'
        },
        'sum': {
            symbol: 'Î£',
            name: 'æ±‚å’Œç¬¦å·',
            explain: 'è¡¨ç¤ºæŠŠå¤šä¸ªæ•°åŠ èµ·æ¥ã€‚åœ¨ç¥ç»ç½‘ç»œä¸­ï¼Œä¸€ä¸ªèŠ‚ç‚¹å¯èƒ½æ”¶åˆ°å¤šä¸ªè¾“å…¥ï¼Œéœ€è¦æŠŠå½±å“åŠ æ€»ã€‚',
            analogy: 'åƒæŠŠå¤šæ¡å°æºªçš„æ°´æ±‡é›†æˆä¸€æ¡æ²³æµã€‚'
        },
        'wnew': {
            symbol: "w' = w - Î·Â·âˆ‚L/âˆ‚w",
            name: 'æƒé‡æ›´æ–°å…¬å¼',
            explain: 'ä½¿ç”¨æ¢¯åº¦ä¸‹é™æ›´æ–°æƒé‡ï¼šæ–°æƒé‡ = æ—§æƒé‡ - å­¦ä¹ ç‡ Ã— æ¢¯åº¦ã€‚è´Ÿå·è¡¨ç¤ºæœç€å‡å°æŸå¤±çš„æ–¹å‘èµ°ã€‚',
            analogy: 'åƒæ ¡å‡†å‡†æ˜Ÿï¼Œæ¯æ¬¡å¾®è°ƒéƒ½è®©ä¸‹ä¸€æ¬¡å°„å‡»æ›´å‡†ã€‚æ¢¯åº¦æŒ‡å‘ä¸Šå¡ï¼Œæˆ‘ä»¬è¦å¾€ä¸‹èµ°ã€‚'
        },
        'relu': {
            symbol: 'ReLU(z) = max(0, z)',
            name: 'ReLU æ¿€æ´»å‡½æ•°',
            explain: 'æ•´æµçº¿æ€§å•å…ƒï¼šæ­£æ•°åŸæ ·è¾“å‡ºï¼Œè´Ÿæ•°å˜æˆ0ã€‚ç®€å•é«˜æ•ˆï¼Œæ˜¯æœ€å¸¸ç”¨çš„æ¿€æ´»å‡½æ•°ã€‚',
            analogy: 'åƒä¸€ä¸ªåªè®©æ­£æ•°é€šè¿‡çš„é—¨ï¼Œè´Ÿæ•°è¢«æ‹¦ä½å˜æˆ0ã€‚'
        },
        'z': {
            symbol: 'z = Î£(wÂ·x) + b',
            name: 'åŠ æƒæ±‚å’Œ',
            explain: 'ç¥ç»å…ƒçš„è¾“å…¥ï¼šæŠŠæ‰€æœ‰è¾“å…¥ä¹˜ä»¥å¯¹åº”æƒé‡ååŠ èµ·æ¥ï¼Œå†åŠ ä¸Šåç½®ã€‚è¿™æ˜¯æ¿€æ´»å‡½æ•°ä¹‹å‰çš„å€¼ã€‚',
            analogy: 'åƒæŠ•ç¥¨è®¡ç¥¨ï¼Œæ¯å¼ ç¥¨ï¼ˆè¾“å…¥ï¼‰æœ‰ä¸åŒæƒé‡ï¼Œæœ€ååŠ ä¸Šä¸€ä¸ªå›ºå®šçš„åŸºç¡€åˆ†ï¼ˆåç½®ï¼‰ã€‚'
        }
    };

    // ========== èŠ‚ç‚¹å’Œè¿æ¥æ•°æ® ==========
    const nodes = {};
    for(let i=1; i<=2; i++) {
        nodes[`x${i}`] = { 
            x: LAYOUT.input.x, 
            y: LAYOUT.input.startY + (i-1)*LAYOUT.input.gap, 
            layer: 'layer-input',
            label: 'è¾“å…¥'
        };
    }
    for(let i=1; i<=3; i++) {
        nodes[`h${i}`] = { 
            x: LAYOUT.hidden.x, 
            y: LAYOUT.hidden.startY + (i-1)*LAYOUT.hidden.gap, 
            layer: 'layer-hidden',
            label: 'éšè—'
        };
    }
    for(let i=1; i<=2; i++) {
        nodes[`o${i}`] = { 
            x: LAYOUT.output.x, 
            y: LAYOUT.output.startY + (i-1)*LAYOUT.output.gap, 
            layer: 'layer-output',
            label: 'è¾“å‡º'
        };
    }

    // è¿æ¥ä¿¡æ¯
    const connections = [];
    // è¾“å…¥å±‚ â†’ éšè—å±‚
    for(let i=1; i<=2; i++) {
        for(let j=1; j<=3; j++) {
            connections.push({
                from: `x${i}`,
                to: `h${j}`,
                id: `w_h${j}_x${i}`,
                label: `w_{H${j}X${i}}`,
                type: 'hid_w',
                idx1: j,
                idx2: i
            });
        }
    }
    // éšè—å±‚ â†’ è¾“å‡ºå±‚
    for(let j=1; j<=3; j++) {
        for(let k=1; k<=2; k++) {
            connections.push({
                from: `h${j}`,
                to: `o${k}`,
                id: `w_o${k}_h${j}`,
                label: `w_{O${k}H${j}}`,
                type: 'out_w',
                idx1: k,
                idx2: j
            });
        }
    }

    // ========== åˆå§‹åŒ– ==========
    function init() {
        createNodes();
        createConnections();
        createLayerTags();
        createLossNode();
        addDecorations();
        
        document.getElementById('btn-play').onclick = togglePlay;
        document.getElementById('btn-next').onclick = () => { stopPlay(); nextStep(); };
        document.getElementById('btn-prev').onclick = () => { stopPlay(); prevStep(); };
        document.getElementById('btn-help').onclick = showHelp;
        
        document.getElementById('symbol-overlay').onclick = (e) => {
            if(e.target.id === 'symbol-overlay') closeSymbolPopup();
        };
        document.addEventListener('keydown', (e) => {
            if(e.key === 'Escape') closeSymbolPopup();
        });
    }

    function createNodes() {
        const container = document.getElementById('nodes-layer');
        for(let id in nodes) {
            const n = nodes[id];
            const div = document.createElement('div');
            div.className = `node ${n.layer}`;
            div.id = `node-${id}`;
            div.style.left = (n.x - NODE_R) + 'px';
            div.style.top = (n.y - NODE_R) + 'px';
            div.innerHTML = `<span>${id}</span><span class="node-label">${n.label}</span>`;
            div.onclick = () => selectNode(id);
            div.onmouseenter = () => showNodeTooltip(id);
            div.onmouseleave = hideTooltip;
            container.appendChild(div);
        }
    }

    function createConnections() {
        const svg = document.getElementById('connections-layer');
        const labelEl = document.getElementById('line-label');
        
        connections.forEach(conn => {
            const start = nodes[conn.from];
            const end = nodes[conn.to];
            
            const angle = Math.atan2(end.y - start.y, end.x - start.x);
            const sx = start.x + Math.cos(angle) * (NODE_R + 3);
            const sy = start.y + Math.sin(angle) * (NODE_R + 3);
            const ex = end.x - Math.cos(angle) * (NODE_R + 8);
            const ey = end.y - Math.sin(angle) * (NODE_R + 8);
            
            const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
            line.setAttribute("x1", sx);
            line.setAttribute("y1", sy);
            line.setAttribute("x2", ex);
            line.setAttribute("y2", ey);
            line.setAttribute("class", "connection-line");
            line.setAttribute("id", `line-${conn.id}`);
            line.setAttribute("marker-end", "url(#arrow-forward)");
            line.style.pointerEvents = 'stroke';
            
            line.onclick = () => selectConnection(conn);
            line.onmouseenter = (e) => {
                const mx = (start.x + end.x) / 2;
                const my = (start.y + end.y) / 2;
                labelEl.style.left = mx + 'px';
                labelEl.style.top = (my - 30) + 'px';
                labelEl.innerHTML = `$${conn.label}$`;
                labelEl.classList.add('visible');
                MathJax.typesetPromise([labelEl]);
            };
            line.onmouseleave = () => {
                labelEl.classList.remove('visible');
            };
            
            svg.appendChild(line);
        });
    }

    function createLayerTags() {
        const container = document.getElementById('labels-layer');
        const tags = [
            { text: 'Input', x: LAYOUT.input.x - 60, y: 50 },
            { text: 'Hidden', x: LAYOUT.hidden.x - 60, y: 50 },
            { text: 'Output', x: LAYOUT.output.x - 60, y: 50 }
        ];
        tags.forEach(t => {
            const div = document.createElement('div');
            div.className = 'layer-tag';
            div.style.left = t.x + 'px';
            div.style.top = t.y + 'px';
            div.innerText = t.text;
            container.appendChild(div);
        });
    }

    function createLossNode() {
        const container = document.getElementById('nodes-layer');
        const div = document.createElement('div');
        div.className = 'loss-node';
        div.style.left = (LAYOUT.loss.x - 40) + 'px';
        div.style.top = (LAYOUT.loss.y - 25) + 'px';
        div.innerHTML = 'Loss L';
        div.style.cursor = 'pointer';
        div.onclick = () => showSymbol('loss');
        container.appendChild(div);
    }

    function addDecorations() {
        const container = document.getElementById('canvas-area');
        const positions = [
            { x: 120, y: 60, char: 'âœ¦' },
            { x: 950, y: 50, char: 'âœ§' },
            { x: 180, y: 350, char: 'Â·' },
            { x: 900, y: 320, char: 'âœ¦' }
        ];
        positions.forEach(p => {
            const span = document.createElement('span');
            span.className = 'deco-star';
            span.style.left = p.x + 'px';
            span.style.top = p.y + 'px';
            span.innerText = p.char;
            container.appendChild(span);
        });
    }

    // ========== äº¤äº’å¤„ç† ==========
    let currentSelection = null;
    let currentScenario = null;
    let currentStepIdx = -1;
    let isPlaying = false;
    let playInterval = null;

    function selectConnection(conn) {
        clearSelection();
        document.getElementById('welcome-hint').classList.add('hidden');
        
        const line = document.getElementById(`line-${conn.id}`);
        line.classList.add('active');
        
        currentSelection = { type: 'connection', data: conn };
        document.getElementById('panel-title').innerHTML = `æƒé‡ <b style="color:#8763c5">$${conn.label}$</b> çš„æ¢¯åº¦æ¨å¯¼`;
        MathJax.typesetPromise([document.getElementById('panel-title')]);
        
        currentScenario = generateScenario(conn.type, conn.idx1, conn.idx2);
        currentStepIdx = -1;
        resetPanel();
        document.getElementById('btn-next').disabled = false;
        document.getElementById('btn-prev').disabled = true;
    }

    function selectNode(nodeId) {
        // åªæœ‰éšè—å±‚å’Œè¾“å‡ºå±‚æœ‰åç½®
        if(nodeId.startsWith('x')) return;
        
        clearSelection();
        document.getElementById('welcome-hint').classList.add('hidden');
        
        const nodeEl = document.getElementById(`node-${nodeId}`);
        nodeEl.classList.add('active');
        
        let type, idx;
        if(nodeId.startsWith('h')) {
            type = 'hid_b';
            idx = parseInt(nodeId[1]);
        } else if(nodeId.startsWith('o')) {
            type = 'out_b';
            idx = parseInt(nodeId[1]);
        }
        
        const labelTex = nodeId.startsWith('h') ? `b_{H${idx}}` : `b_{O${idx}}`;
        currentSelection = { type: 'node', data: { id: nodeId, type, idx, label: labelTex } };
        document.getElementById('panel-title').innerHTML = `åç½® <b style="color:#8763c5">$${labelTex}$</b> çš„æ¢¯åº¦æ¨å¯¼`;
        MathJax.typesetPromise([document.getElementById('panel-title')]);
        
        currentScenario = generateScenario(type, idx, null);
        currentStepIdx = -1;
        resetPanel();
        document.getElementById('btn-next').disabled = false;
        document.getElementById('btn-prev').disabled = true;
    }

    function clearSelection() {
        document.querySelectorAll('.connection-line.active').forEach(l => l.classList.remove('active'));
        document.querySelectorAll('.node.active').forEach(n => n.classList.remove('active'));
        document.getElementById('arrows-layer').innerHTML = '';
        currentSelection = null;
    }

    function resetPanel() {
        document.getElementById('panel-content').innerHTML = '';
        document.getElementById('arrows-layer').innerHTML = '';
        const el = document.getElementById('floating-formula-display'); 
        if(el) el.classList.remove('visible');
    }

    // ========== åœºæ™¯ç”Ÿæˆ - æ›´è¯¦ç»†çš„æ¨å¯¼ ==========
    function generateScenario(type, idx1, idx2) {
        const steps = [];
        
        if (type === 'out_w') {
            // è¾“å‡ºå±‚æƒé‡çš„è¯¦ç»†æ¨å¯¼
            const ok = `o${idx1}`, hj = `h${idx2}`;
            
            steps.push({
                text: "æŸå¤±å‡½æ•°å®šä¹‰",
                math: `<span class="clickable-symbol" onclick="showSymbol('loss')">$L = \\frac{1}{n}\\sum_{i=1}^{n}\\frac{1}{2}(o_i - \\hat{o}_i)^2$</span>
                <br><span style="color:#78909C;font-size:12px;">å…¶ä¸­ $o_i$ æ˜¯é¢„æµ‹å€¼ï¼Œ$\\hat{o}_i$ æ˜¯çœŸå®å€¼</span>`,
                explain: 'å‡æ–¹è¯¯å·®ï¼šé¢„æµ‹å€¼ä¸çœŸå®å€¼å·®è·çš„å¹³æ–¹å’Œ'
            });
            
            steps.push({
                text: "è¾“å‡ºèŠ‚ç‚¹è¡¨è¾¾å¼",
                math: `$o_{${idx1}} = (h_1 \\cdot w_{O${idx1}H1} + h_2 \\cdot w_{O${idx1}H2} + h_3 \\cdot w_{O${idx1}H3}) + b_{O${idx1}}$
                <br><span style="color:#78909C;font-size:12px;">è¾“å‡º = æ‰€æœ‰éšè—å±‚è¾“å‡ºçš„åŠ æƒå’Œ + åç½®</span>`,
                explain: 'è¾“å‡ºèŠ‚ç‚¹æ˜¯éšè—å±‚çš„çº¿æ€§ç»„åˆ'
            });
            
            steps.push({
                text: "é“¾å¼æ³•åˆ™å±•å¼€",
                math: `<span class="clickable-symbol" onclick="showSymbol('chain')">$\\frac{\\partial L}{\\partial w_{O${idx1}H${idx2}}} = \\frac{\\partial L}{\\partial o_{${idx1}}} \\cdot \\frac{\\partial o_{${idx1}}}{\\partial w_{O${idx1}H${idx2}}}$</span>
                <br><span style="color:#78909C;font-size:12px;">æ¢¯åº¦ = æŸå¤±å¯¹è¾“å‡ºçš„å¯¼æ•° Ã— è¾“å‡ºå¯¹æƒé‡çš„å¯¼æ•°</span>`,
                arrow: { from: 'loss', to: ok },
                explain: 'å¤æ‚å¯¼æ•°æ‹†æˆç®€å•éƒ¨åˆ†ç›¸ä¹˜'
            });
            
            steps.push({
                text: "è®¡ç®— âˆ‚L/âˆ‚o",
                math: `$\\frac{\\partial L}{\\partial o_{${idx1}}} = \\frac{1}{n}(o_{${idx1}} - \\hat{o}_{${idx1}})$
                <br><span style="color:#78909C;font-size:12px;">å¯¹ $\\frac{1}{2}(o-\\hat{o})^2$ æ±‚å¯¼ï¼Œç³»æ•°2å’Œ1/2æŠµæ¶ˆ</span>`,
                explain: 'é¢„æµ‹å€¼å‡çœŸå®å€¼ï¼Œå°±æ˜¯è¯¯å·®'
            });
            
            steps.push({
                text: "è®¡ç®— âˆ‚o/âˆ‚w",
                math: `$\\frac{\\partial o_{${idx1}}}{\\partial w_{O${idx1}H${idx2}}} = h_{${idx2}}$
                <br><span style="color:#78909C;font-size:12px;">çº¿æ€§ç»„åˆå¯¹æŸæƒé‡æ±‚å¯¼ï¼Œç»“æœå°±æ˜¯å¯¹åº”çš„è¾“å…¥å€¼</span>`,
                arrow: { from: ok, to: hj },
                explain: 'æƒé‡çš„"è´¡çŒ®è€…"å°±æ˜¯å®ƒè¿æ¥çš„éšè—èŠ‚ç‚¹è¾“å‡º'
            });
            
            steps.push({
                text: "åˆå¹¶å¾—åˆ°æ¢¯åº¦",
                math: `$\\frac{\\partial L}{\\partial w} = \\frac{1}{n}(o_{${idx1}} - \\hat{o}_{${idx1}}) \\cdot h_{${idx2}}$
                <br><span style="color:#1976D2;font-weight:bold;">= è¯¯å·® Ã— è¾“å…¥</span>`,
                explain: 'è¿™å°±æ˜¯è¿™ä¸ªæƒé‡çš„æ¢¯åº¦ï¼'
            });
            
            steps.push({
                text: "æƒé‡æ›´æ–°å…¬å¼",
                math: `<span class="clickable-symbol" onclick="showSymbol('wnew')">$w'_{O${idx1}H${idx2}} = w_{O${idx1}H${idx2}} - $ <span class="clickable-symbol" onclick="showSymbol('eta')">$\\eta$</span> $ \\cdot \\frac{\\partial L}{\\partial w_{O${idx1}H${idx2}}}$</span>
                <br><span style="color:#78909C;font-size:12px;">æ–°æƒé‡ = æ—§æƒé‡ - å­¦ä¹ ç‡ Ã— æ¢¯åº¦</span>`,
                explain: 'æ²¿ç€æ¢¯åº¦çš„åæ–¹å‘æ›´æ–°ï¼Œå‡å°æŸå¤±'
            });
        }
        else if (type === 'out_b') {
            // è¾“å‡ºå±‚åç½®
            const ok = `o${idx1}`;
            
            steps.push({
                text: "æŸå¤±å‡½æ•°",
                math: `$L = \\frac{1}{n}\\sum\\frac{1}{2}(o_i - \\hat{o}_i)^2$`,
                explain: 'åŒæ ·ä»æŸå¤±å‡½æ•°å‡ºå‘'
            });
            
            steps.push({
                text: "é“¾å¼æ³•åˆ™",
                math: `$\\frac{\\partial L}{\\partial b_{O${idx1}}} = \\frac{\\partial L}{\\partial o_{${idx1}}} \\cdot \\frac{\\partial o_{${idx1}}}{\\partial b_{O${idx1}}}$`,
                arrow: { from: 'loss', to: ok },
                explain: 'åç½®çš„æ¢¯åº¦ä¹Ÿç”¨é“¾å¼æ³•åˆ™'
            });
            
            steps.push({
                text: "âˆ‚L/âˆ‚o å·²çŸ¥",
                math: `$\\frac{\\partial L}{\\partial o_{${idx1}}} = \\frac{1}{n}(o_{${idx1}} - \\hat{o}_{${idx1}})$`,
                explain: 'å’Œæƒé‡ä¸€æ ·çš„è¯¯å·®é¡¹'
            });
            
            steps.push({
                text: "âˆ‚o/âˆ‚b = 1 (å…³é”®!)",
                math: `$\\frac{\\partial o_{${idx1}}}{\\partial b_{O${idx1}}} = 1$
                <br><span style="color:#78909C;font-size:12px;">å› ä¸º $o = \\sum w \\cdot h + b$ï¼Œb çš„ç³»æ•°æ˜¯ 1</span>`,
                explain: 'åç½®çš„"è¾“å…¥"æ’ä¸º1ï¼Œè¿™æ˜¯å®ƒå’Œæƒé‡çš„åŒºåˆ«'
            });
            
            steps.push({
                text: "åç½®æ¢¯åº¦",
                math: `$\\frac{\\partial L}{\\partial b} = \\frac{1}{n}(o_{${idx1}} - \\hat{o}_{${idx1}})$
                <br><span style="color:#1976D2;font-weight:bold;">= è¯¯å·®æœ¬èº«</span>`,
                explain: 'åç½®æ¢¯åº¦å°±æ˜¯è¯¯å·®ï¼Œä¸éœ€è¦ä¹˜è¾“å…¥'
            });
            
            steps.push({
                text: "æ›´æ–°å…¬å¼",
                math: `$b'_{O${idx1}} = b_{O${idx1}} - \\eta \\cdot \\frac{\\partial L}{\\partial b_{O${idx1}}}$`,
                explain: 'åŒæ ·ç”¨æ¢¯åº¦ä¸‹é™æ›´æ–°'
            });
        }
        else if (type === 'hid_w') {
            // éšè—å±‚æƒé‡ - éœ€è¦è¯¯å·®å›ä¼ 
            const hj = `h${idx1}`, xi = `x${idx2}`;
            
            steps.push({
                text: "éšè—å±‚å¤æ‚æ€§",
                math: `$\\frac{\\partial L}{\\partial w_{H${idx1}X${idx2}}}$ éœ€è¦ç©¿è¿‡å¤šå±‚ï¼
                <br><span style="color:#78909C;font-size:12px;">éšè—å±‚æƒé‡å½±å“å¤šä¸ªè¾“å‡ºèŠ‚ç‚¹ï¼Œè¯¯å·®éœ€è¦"å›ä¼ "</span>`,
                explain: 'éšè—å±‚ä¸ç›´æ¥è¿æ¥æŸå¤±ï¼Œè®¡ç®—æ›´å¤æ‚'
            });
            
            steps.push({
                text: "éšè—èŠ‚ç‚¹è¡¨è¾¾å¼",
                math: `$z_{${idx1}} = x_1 \\cdot w_{H${idx1}X1} + x_2 \\cdot w_{H${idx1}X2} + b_{H${idx1}}$
                <br>$h_{${idx1}} = $ <span class="clickable-symbol" onclick="showSymbol('relu')">$ReLU(z_{${idx1}})$</span>`,
                explain: 'å…ˆåŠ æƒæ±‚å’Œå¾—zï¼Œå†è¿‡æ¿€æ´»å‡½æ•°å¾—h'
            });
            
            steps.push({
                text: "å®Œæ•´é“¾å¼æ³•åˆ™",
                math: `$\\frac{\\partial L}{\\partial w_{H${idx1}X${idx2}}} = \\frac{\\partial L}{\\partial h_{${idx1}}} \\cdot \\frac{\\partial h_{${idx1}}}{\\partial z_{${idx1}}} \\cdot \\frac{\\partial z_{${idx1}}}{\\partial w_{H${idx1}X${idx2}}}$`,
                explain: 'è¦ç©¿è¿‡3å±‚ï¼šLâ†’hâ†’zâ†’w'
            });
            
            steps.push({
                text: "è¯¯å·®å›ä¼  âˆ‚L/âˆ‚h (å…³é”®!)",
                math: `$\\frac{\\partial L}{\\partial h_{${idx1}}} = \\sum_{k=1}^{2} \\frac{\\partial L}{\\partial o_k} \\cdot \\frac{\\partial o_k}{\\partial h_{${idx1}}}$
                <br>$= \\frac{1}{n}(o_1 - \\hat{o}_1) \\cdot w_{O1H${idx1}} + \\frac{1}{n}(o_2 - \\hat{o}_2) \\cdot w_{O2H${idx1}}$`,
                arrows: [{from: `o1`, to: hj}, {from: `o2`, to: hj}],
                explain: 'å¤šä¸ªè¾“å‡ºçš„è¯¯å·®æŒ‰æƒé‡æ¯”ä¾‹å›ä¼ åˆ°éšè—èŠ‚ç‚¹'
            });
            
            steps.push({
                text: "æ¿€æ´»å‡½æ•°å¯¼æ•°",
                math: `<span class="clickable-symbol" onclick="showSymbol('fprime')">$\\frac{\\partial h_{${idx1}}}{\\partial z_{${idx1}}} = I(z_{${idx1}} > 0)$</span>
                <br><span style="color:#78909C;font-size:12px;">ReLUå¯¼æ•°ï¼šz>0æ—¶ä¸º1ï¼Œzâ‰¤0æ—¶ä¸º0</span>`,
                explain: 'I()æ˜¯æŒ‡ç¤ºå‡½æ•°ï¼Œæ‹¬å·å†…ä¸ºçœŸåˆ™ä¸º1'
            });
            
            steps.push({
                text: "è¾“å…¥è´¡çŒ®",
                math: `$\\frac{\\partial z_{${idx1}}}{\\partial w_{H${idx1}X${idx2}}} = x_{${idx2}}$`,
                arrow: { from: hj, to: xi },
                explain: 'è¿™ä¸ªæƒé‡è¿æ¥çš„è¾“å…¥å€¼'
            });
            
            steps.push({
                text: "åˆå¹¶å¾—åˆ°æ¢¯åº¦",
                math: `$\\frac{\\partial L}{\\partial w} = \\delta_{h${idx1}} \\cdot I(z>0) \\cdot x_{${idx2}}$
                <br><span style="color:#78909C;font-size:12px;">å…¶ä¸­ $\\delta_{h${idx1}} = $ å›ä¼ è¯¯å·®å’Œ</span>`,
                explain: 'å›ä¼ è¯¯å·® Ã— æ¿€æ´»å¯¼æ•° Ã— è¾“å…¥'
            });
            
            steps.push({
                text: "æ›´æ–°å…¬å¼",
                math: `$w'_{H${idx1}X${idx2}} = w_{H${idx1}X${idx2}} - \\eta \\cdot \\frac{\\partial L}{\\partial w_{H${idx1}X${idx2}}}$`,
                explain: 'åŒæ ·ç”¨æ¢¯åº¦ä¸‹é™æ›´æ–°'
            });
        }
        else if (type === 'hid_b') {
            // éšè—å±‚åç½®
            const hj = `h${idx1}`;
            
            steps.push({
                text: "éšè—å±‚åç½®æ¢¯åº¦",
                math: `$\\frac{\\partial L}{\\partial b_{H${idx1}}} = \\frac{\\partial L}{\\partial h_{${idx1}}} \\cdot \\frac{\\partial h_{${idx1}}}{\\partial z_{${idx1}}} \\cdot \\frac{\\partial z_{${idx1}}}{\\partial b_{H${idx1}}}$`,
                explain: 'åç½®ä¹Ÿéœ€è¦è¯¯å·®å›ä¼ '
            });
            
            steps.push({
                text: "è¯¯å·®å›ä¼ åˆ° h",
                math: `$\\frac{\\partial L}{\\partial h_{${idx1}}} = \\sum_{k} \\frac{1}{n}(o_k - \\hat{o}_k) \\cdot w_{OkH${idx1}}$`,
                arrows: [{from: `o1`, to: hj}, {from: `o2`, to: hj}],
                explain: 'æ±‡æ€»æ‰€æœ‰è¾“å‡ºèŠ‚ç‚¹ä¼ å›çš„è¯¯å·®'
            });
            
            steps.push({
                text: "æ¿€æ´»å‡½æ•°å¯¼æ•°",
                math: `$\\frac{\\partial h_{${idx1}}}{\\partial z_{${idx1}}} = I(z_{${idx1}} > 0)$`,
                explain: 'ReLUçš„å¯¼æ•°'
            });
            
            steps.push({
                text: "âˆ‚z/âˆ‚b = 1",
                math: `$\\frac{\\partial z_{${idx1}}}{\\partial b_{H${idx1}}} = 1$
                <br><span style="color:#78909C;font-size:12px;">åç½®çš„"è¾“å…¥"æ’ä¸º1</span>`,
                explain: 'å’Œè¾“å‡ºå±‚åç½®ä¸€æ ·'
            });
            
            steps.push({
                text: "åç½®æ¢¯åº¦",
                math: `$\\frac{\\partial L}{\\partial b} = \\delta_{h${idx1}} \\cdot I(z>0)$
                <br><span style="color:#1976D2;font-weight:bold;">= å›ä¼ è¯¯å·® Ã— æ¿€æ´»å¯¼æ•°</span>`,
                explain: 'ä¸éœ€è¦ä¹˜è¾“å…¥ï¼ˆè¾“å…¥æ’ä¸º1ï¼‰'
            });
            
            steps.push({
                text: "æ›´æ–°å…¬å¼",
                math: `$b'_{H${idx1}} = b_{H${idx1}} - \\eta \\cdot \\frac{\\partial L}{\\partial b_{H${idx1}}}$`,
                explain: 'æ¢¯åº¦ä¸‹é™æ›´æ–°'
            });
        }
        return steps;
    }

    function showFloatingFormula(step) {
        let el = document.getElementById('floating-formula-display');
        if (!el) {
            el = document.createElement('div');
            el.id = 'floating-formula-display';
            el.className = 'floating-formula';
            document.getElementById('canvas-area').appendChild(el);
        }

        // Determine position
        let targetX = 0, targetY = 0;
        let hasTarget = false;

        // 1. Priority: Explicit text matching for specific locations
        if (step.text.includes("æŸå¤±å‡½æ•°") || step.text.includes("é“¾å¼æ³•åˆ™")) {
             targetX = LAYOUT.loss.x;
             targetY = LAYOUT.loss.y;
             hasTarget = true;
        } 
        // 2. Priority: Explicit arrows
        else if (step.arrow) {
            const node = nodes[step.arrow.to];
            if (node) {
                targetX = node.x;
                targetY = node.y;
                hasTarget = true;
            } else if (step.arrow.to === 'loss') {
                 targetX = LAYOUT.loss.x;
                 targetY = LAYOUT.loss.y;
                 hasTarget = true;
            }
        } else if (step.arrows && step.arrows.length > 0) {
             const node = nodes[step.arrows[0].to];
             if (node) {
                targetX = node.x;
                targetY = node.y;
                hasTarget = true;
             }
        } 
        // 3. Priority: Infer from text and selection
        else if (currentSelection) {
            // Helper to get node by type and index
            const getNode = (type, idx) => nodes[`${type}${idx}`];
            
            if (step.text.includes("è¾“å‡ºèŠ‚ç‚¹") || step.text.includes("âˆ‚L/âˆ‚o")) {
                let idx = currentSelection.data.idx1 || currentSelection.data.idx;
                if (currentSelection.data.type === 'out_w' || currentSelection.data.type === 'out_b') {
                     const node = getNode('o', idx);
                     if (node) { targetX = node.x; targetY = node.y; hasTarget = true; }
                }
            }
            else if (step.text.includes("éšè—èŠ‚ç‚¹") || step.text.includes("âˆ‚L/âˆ‚h")) {
                 let idx = currentSelection.data.idx1 || currentSelection.data.idx;
                 if (currentSelection.data.type === 'hid_w' || currentSelection.data.type === 'hid_b') {
                     const node = getNode('h', idx);
                     if (node) { targetX = node.x; targetY = node.y; hasTarget = true; }
                 }
            }
            
            // 4. Fallback: Selection location
            if (!hasTarget) {
                if (currentSelection.type === 'connection') {
                    const conn = currentSelection.data;
                    const start = nodes[conn.from];
                    const end = nodes[conn.to];
                    if (start && end) {
                        targetX = (start.x + end.x) / 2;
                        targetY = (start.y + end.y) / 2;
                        hasTarget = true;
                    }
                } else if (currentSelection.type === 'node') {
                    const node = nodes[currentSelection.data.id];
                    if (node) {
                        targetX = node.x;
                        targetY = node.y;
                        hasTarget = true;
                    }
                }
            }
        }

        if (hasTarget) {
            // Offset slightly to not cover the node/line
            el.style.left = (targetX + 20) + 'px';
            el.style.top = (targetY - 40) + 'px';
            
            // Use the math content
            el.innerHTML = step.math;
            
            // Render MathJax
            MathJax.typesetPromise([el]).then(() => {
                el.classList.add('visible');
            });
        } else {
            el.classList.remove('visible');
        }
    }

    // ========== æ¸²æŸ“æ­¥éª¤ ==========
    function renderStep(idx) {
        if (!currentScenario || idx >= currentScenario.length) return;
        const step = currentScenario[idx];
        
        showFloatingFormula(step);

        // ç»˜åˆ¶åå‘ä¼ æ’­ç®­å¤´ï¼ˆé’ç»¿è‰²è™šçº¿ï¼‰
        if (step.arrow) drawBackpropArrow(step.arrow.from, step.arrow.to);
        if (step.arrows) step.arrows.forEach(a => drawBackpropArrow(a.from, a.to));
        
        // ç§»é™¤ä¹‹å‰çš„é«˜äº®
        document.querySelectorAll('.step-card.current').forEach(c => c.classList.remove('current'));
        
        // åˆ›å»ºå¡ç‰‡
        const card = document.createElement('div');
        card.className = 'step-card';
        card.id = `step-card-${idx}`;
        card.innerHTML = `
            <div class="step-title"><span class="step-badge">${idx+1}</span>${step.text}</div>
            <div class="step-math">${step.math}</div>
            ${step.explain ? `<div style="margin-top:8px;font-size:12px;color:#78909C;">ğŸ’¡ ${step.explain}</div>` : ''}
        `;
        document.getElementById('panel-content').appendChild(card);
        
        MathJax.typesetPromise([card]).then(() => {
            setTimeout(() => {
                card.classList.add('visible');
                // é«˜äº®å½“å‰å¡ç‰‡
                card.classList.add('current');
                // æ»šåŠ¨åˆ°å¡ç‰‡ä¸­é—´ä½ç½®
                scrollToCard(card);
            }, 50);
        });
    }

    // ========== æ»šåŠ¨åˆ°å¡ç‰‡ä¸­é—´ ==========
    function scrollToCard(card) {
        const container = document.getElementById('panel-content');
        const containerRect = container.getBoundingClientRect();
        const cardRect = card.getBoundingClientRect();
        
        // è®¡ç®—éœ€è¦æ»šåŠ¨çš„è·ç¦»ï¼Œä½¿å¡ç‰‡åœ¨å®¹å™¨ä¸­é—´
        const scrollLeft = card.offsetLeft - (containerRect.width / 2) + (cardRect.width / 2);
        
        // å¹³æ»‘æ»šåŠ¨
        container.scrollTo({
            left: scrollLeft,
            behavior: 'smooth'
        });
    }

    function drawBackpropArrow(from, to) {
        const svg = document.getElementById('arrows-layer');
        const startNode = nodes[from] || { x: LAYOUT.loss.x, y: LAYOUT.loss.y };
        const endNode = nodes[to];
        
        const dx = endNode.x - startNode.x;
        const dy = endNode.y - startNode.y;
        const angle = Math.atan2(dy, dx);
        
        const sx = startNode.x + (from === 'loss' ? -40 : 0);
        const sy = startNode.y;
        const ex = endNode.x - Math.cos(angle) * (NODE_R + 10);
        const ey = endNode.y - Math.sin(angle) * (NODE_R + 10);
        
        // æ›²çº¿æ§åˆ¶ç‚¹
        const mx = (sx + ex) / 2;
        const my = (sy + ey) / 2;
        let curvature = (sy > ey) ? -0.3 : 0.3;
        if (from === 'loss') curvature = 0;
        const cx = mx - dy * curvature;
        const cy = my + dx * curvature;
        
        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        path.setAttribute("d", `M ${sx} ${sy} Q ${cx} ${cy} ${ex} ${ey}`);
        path.setAttribute("class", "backprop-arrow");
        path.setAttribute("marker-end", "url(#arrow-backprop)");
        svg.appendChild(path);
    }

    // ========== æ’­æ”¾æ§åˆ¶ ==========
    function nextStep() {
        if (!currentScenario) return;
        if (currentStepIdx < currentScenario.length - 1) {
            currentStepIdx++;
            renderStep(currentStepIdx);
            document.getElementById('btn-prev').disabled = false;
        }
        if (currentStepIdx === currentScenario.length - 1) {
            document.getElementById('btn-next').disabled = true;
            if (isPlaying) stopPlay();
        }
    }

    function prevStep() {
        if (currentStepIdx > 0) {
            currentStepIdx--;
            // é‡æ–°æ¸²æŸ“åˆ°å½“å‰æ­¥
            resetPanel();
            for (let i = 0; i <= currentStepIdx; i++) {
                const isLast = i === currentStepIdx;
                renderStepForReplay(i, isLast);
            }
            document.getElementById('btn-next').disabled = false;
        }
        if (currentStepIdx <= 0) {
            document.getElementById('btn-prev').disabled = true;
        }
    }

    // ç”¨äºå›æ”¾æ—¶çš„æ¸²æŸ“ï¼ˆä¸éœ€è¦åŠ¨ç”»å»¶è¿Ÿï¼‰
    function renderStepForReplay(idx, isCurrent) {
        if (!currentScenario || idx >= currentScenario.length) return;
        const step = currentScenario[idx];
        
        if (isCurrent) showFloatingFormula(step);

        if (step.arrow) drawBackpropArrow(step.arrow.from, step.arrow.to);
        if (step.arrows) step.arrows.forEach(a => drawBackpropArrow(a.from, a.to));
        
        const card = document.createElement('div');
        card.className = 'step-card visible';
        card.id = `step-card-${idx}`;
        if (isCurrent) card.classList.add('current');
        
        card.innerHTML = `
            <div class="step-title"><span class="step-badge">${idx+1}</span>${step.text}</div>
            <div class="step-math">${step.math}</div>
            ${step.explain ? `<div style="margin-top:8px;font-size:12px;color:#78909C;">ğŸ’¡ ${step.explain}</div>` : ''}
        `;
        document.getElementById('panel-content').appendChild(card);
        
        if (isCurrent) {
            MathJax.typesetPromise([card]).then(() => {
                scrollToCard(card);
            });
        } else {
            MathJax.typesetPromise([card]);
        }
    }

    function togglePlay() {
        if (!currentScenario) {
            selectConnection(connections[0]);
        }
        
        isPlaying = !isPlaying;
        const btn = document.getElementById('btn-play');
        
        if (isPlaying) {
            btn.innerHTML = 'â¸ æš‚åœ';
            btn.style.background = '#8763c5';
            
            if (currentStepIdx === currentScenario.length - 1) {
                resetPanel();
                currentStepIdx = -1;
                document.getElementById('btn-next').disabled = false;
            }
            
            if (currentStepIdx < currentScenario.length - 1) nextStep();
            playInterval = setInterval(() => {
                if (currentStepIdx < currentScenario.length - 1) {
                    nextStep();
                } else {
                    stopPlay();
                }
            }, 3000);
        } else {
            stopPlay();
        }
    }

    function stopPlay() {
        isPlaying = false;
        clearInterval(playInterval);
        const btn = document.getElementById('btn-play');
        btn.innerHTML = 'â–¶ è‡ªåŠ¨æ’­æ”¾';
        btn.style.background = '';
    }

    // ========== ç¬¦å·å¼¹çª— ==========
    function showSymbol(key) {
        const info = symbolDict[key];
        if (!info) return;
        
        document.getElementById('popup-symbol').innerText = info.symbol;
        document.getElementById('popup-name').innerText = info.name;
        document.getElementById('popup-explain').innerText = info.explain;
        document.getElementById('popup-analogy').innerText = info.analogy;
        
        const overlay = document.getElementById('symbol-overlay');
        const popup = document.getElementById('symbol-popup');
        
        popup.style.left = 'calc(50% - 170px)';
        popup.style.top = 'calc(50% - 140px)';
        
        overlay.classList.add('visible');
    }

    function closeSymbolPopup() {
        document.getElementById('symbol-overlay').classList.remove('visible');
    }

    // ========== æç¤º ==========
    function showNodeTooltip(nodeId) {}
    function hideTooltip() {}

    function showHelp() {
        alert('ğŸ¯ ä½¿ç”¨æŒ‡å—ï¼š\n\n1. ç‚¹å‡»ç½‘ç»œå›¾ä¸­çš„ã€è¿çº¿ã€‘æŸ¥çœ‹æƒé‡çš„æ¢¯åº¦æ¨å¯¼\n2. ç‚¹å‡»ã€èŠ‚ç‚¹ã€‘(h1-h3, o1-o2) æŸ¥çœ‹åç½®çš„æ¢¯åº¦æ¨å¯¼\n3. ç‚¹å‡»ã€Lossã€‘æŸ¥çœ‹æŸå¤±å‡½æ•°è§£é‡Š\n4. å…¬å¼ä¸­å¸¦è™šçº¿çš„ç¬¦å·å¯ä»¥ç‚¹å‡»æŸ¥çœ‹è§£é‡Š\n5. ä½¿ç”¨ä¸Šæ–¹æŒ‰é’®æ§åˆ¶æ’­æ”¾è¿›åº¦\n\né¢œè‰²è¯´æ˜ï¼š\nâ€¢ æµ…å’–è‰²å®çº¿ = å‰å‘ä¼ æ’­è¿æ¥\nâ€¢ é’ç»¿è‰²è™šçº¿ = åå‘ä¼ æ’­è·¯å¾„\n\näº«å—å­¦ä¹ ï¼âœ¨');
    }

    init();
</script>
</body>
</html>
